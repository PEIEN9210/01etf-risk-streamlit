# -*- coding: utf-8 -*-
"""app.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1Y1jRJvzhlUjdd66vnUOBj57YzwXHYc1s
"""

# app.py
# -*- coding: utf-8 -*-

import streamlit as st
import pandas as pd
import numpy as np
import yfinance as yf
from datetime import datetime, timedelta

# ===============================
# Streamlit åŸºæœ¬è¨­å®š
# ===============================
st.set_page_config(page_title="å°ç£ ETF å€‹äººåŒ–é¢¨éšªæ¨è–¦", layout="wide")
st.title("ğŸ“Š å°ç£ ETF ç†±é–€æ’è¡Œ Ã— Sharpe + Î¸-model å€‹äººåŒ–æ¨è–¦")

CACHE_TTL = 3600
TRADING_DAYS = 252
MARKET_TICKER = "0050.TW"   # å¸‚å ´åŸºæº–ï¼ˆCAPMï¼‰

# ===============================
# 1ï¸âƒ£ TWSE ETF æˆäº¤é‡ï¼ˆHTML ç©©å®šç‰ˆï¼‰
# ===============================
@st.cache_data(ttl=CACHE_TTL)
def fetch_twse_etf_volume(days=3):
    results = []
    today = datetime.today()

    for i in range(1, days * 3 + 1):
        date = (today - timedelta(days=i)).strftime("%Y%m%d")
        url = f"https://www.twse.com.tw/exchangeReport/ETFDaily?date={date}"

        try:
            tables = pd.read_html(url)
            df = tables[0]
            df.columns = df.columns.get_level_values(-1)

            df = df[["è­‰åˆ¸ä»£è™Ÿ", "æˆäº¤è‚¡æ•¸"]]
            df["æˆäº¤è‚¡æ•¸"] = (
                df["æˆäº¤è‚¡æ•¸"]
                .astype(str)
                .str.replace(",", "")
                .astype(float)
            )

            results.append(df)

            if len(results) >= days:
                break
        except Exception:
            continue

    if not results:
        return pd.DataFrame()

    vol_df = pd.concat(results)

    return (
        vol_df
        .groupby("è­‰åˆ¸ä»£è™Ÿ")["æˆäº¤è‚¡æ•¸"]
        .mean()
        .reset_index()
        .rename(columns={"æˆäº¤è‚¡æ•¸": "è¿‘Næ—¥å¹³å‡æˆäº¤é‡"})
        .sort_values("è¿‘Næ—¥å¹³å‡æˆäº¤é‡", ascending=False)
    )

# ===============================
# 2ï¸âƒ£ Yahoo Finance ETF è³‡æ–™
# ===============================
@st.cache_data(ttl=CACHE_TTL)
def fetch_etf_price_data(ticker):
    data = yf.download(ticker, period="1y", auto_adjust=True, progress=False)
    return data["Close"] if not data.empty else pd.Series()

# ===============================
# 3ï¸âƒ£ Sharpe Ratio
# ===============================
def compute_sharpe(returns):
    if returns.std() == 0:
        return 0.0
    return (returns.mean() / returns.std()) * np.sqrt(TRADING_DAYS)

# ===============================
# 4ï¸âƒ£ Betaï¼ˆCAPMï¼‰
# ===============================
def compute_beta(asset_ret, market_ret):
    if market_ret.var() == 0:
        return 1.0
    return np.cov(asset_ret, market_ret)[0, 1] / market_ret.var()

# ===============================
# 5ï¸âƒ£ Î¸-modelï¼ˆæ•¸æ“šåŒ–ã€å›ºå®šç¯„åœï¼‰
# ===============================
def calculate_theta(age, horizon, loss_tol, reaction):
    """
    Î¸ âˆˆ [-1, +1]
    """
    theta = 0
    theta += (40 - age) / 40 * 0.2
    theta += horizon / 30 * 0.3
    theta += loss_tol / 50 * 0.3
    theta += {"ç«‹å³è³£å‡º": -0.2, "æŒæœ‰è§€æœ›": 0.0, "é€¢ä½åŠ ç¢¼": 0.2}[reaction]
    return round(np.clip(theta, -1, 1), 2)

# ===============================
# ä½¿ç”¨è€…è¼¸å…¥
# ===============================
st.subheader("ğŸ‘¤ æŠ•è³‡äººé¢¨éšªè¨­å®š")
c1, c2, c3, c4 = st.columns(4)
age = c1.slider("å¹´é½¡", 20, 80, 35)
horizon = c2.slider("æŠ•è³‡å¹´é™ï¼ˆå¹´ï¼‰", 1, 30, 10)
loss_tol = c3.slider("æœ€å¤§å¯æ¥å—æå¤± (%)", 0, 50, 15)
reaction = c4.radio("å¸‚å ´ä¸‹è·Œ 20% æ™‚", ["ç«‹å³è³£å‡º", "æŒæœ‰è§€æœ›", "é€¢ä½åŠ ç¢¼"])

theta = calculate_theta(age, horizon, loss_tol, reaction)
st.info(f"ğŸ¯ æŠ•è³‡äºº Î¸ å€¼ = {theta}")

# ===============================
# ä¸»æµç¨‹
# ===============================
if st.button("ğŸš€ è¨ˆç®—ç†±é–€ ETF Ã— å€‹äººåŒ–æ¨è–¦"):

    # 1ï¸âƒ£ ç†±é–€ ETFï¼ˆæˆäº¤é‡ï¼‰
    vol_df = fetch_twse_etf_volume(days=3)
    if vol_df.empty:
        st.error("âš  ç„¡æ³•å–å¾— TWSE æˆäº¤é‡è³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦")
        st.stop()

    hot_etfs = vol_df.head(10)["è­‰åˆ¸ä»£è™Ÿ"].tolist()
    hot_etfs = [f"{x}.TW" for x in hot_etfs]

    market_price = fetch_etf_price_data(MARKET_TICKER)
    market_ret = market_price.pct_change().dropna()

    records = []

    for etf in hot_etfs:
        price = fetch_etf_price_data(etf)
        if price.empty:
            continue

        ret = price.pct_change().dropna()

        sharpe = compute_sharpe(ret)
        beta = compute_beta(ret, market_ret)

        # å€‹äººåŒ–é¢¨éšªè·é›¢ï¼ˆSharpe é«˜ + Beta æ¥è¿‘ Î¸ åå¥½ï¼‰
        personal_score = sharpe - abs(beta - (1 + theta))

        records.append({
            "ETF": etf,
            "Sharpe Ratio": round(sharpe, 2),
            "Beta": round(beta, 2),
            "å€‹äººåŒ–åˆ†æ•¸": round(personal_score, 3)
        })

    result_df = pd.DataFrame(records).sort_values("å€‹äººåŒ–åˆ†æ•¸", ascending=False)

    st.subheader("ğŸ“ˆ ç†±é–€ ETF Ã— å€‹äººåŒ–æ¨è–¦æ’åº")
    st.dataframe(result_df, use_container_width=True)

st.caption("ğŸ“Œ è³‡æ–™ä¾†æºï¼šTWSEï¼ˆHTMLï¼‰ã€Yahoo Financeï½œåƒ…ä¾›ç ”ç©¶èˆ‡æ•™å­¸ä½¿ç”¨")
