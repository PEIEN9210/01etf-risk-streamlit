# -*- coding: utf-8 -*-
"""app.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1Y1jRJvzhlUjdd66vnUOBj57YzwXHYc1s
"""

# app.py
# -*- coding: utf-8 -*-
import streamlit as st
import pandas as pd
import numpy as np
import yfinance as yf
from datetime import datetime, timedelta

st.set_page_config(page_title="å°ç£ ETF æ™ºæ…§æ’åº", layout="wide")
st.title("ğŸ“Š å°ç£ç†±é–€ ETF + å€‹äººåŒ–æ¨è–¦ (Sharpe + Î¸-model)")

TOP_N = 5  # é¡¯ç¤ºå‰ N å

# -------------------------------
# ETF åŸºæœ¬åˆ—è¡¨èˆ‡å‹æ…‹
# -------------------------------
ETF_LIST = [
    "0050.TW", "0056.TW", "006208.TW", "00713.TW",
    "00878.TW", "00692.TW", "00900.TW", "00695B.TW",
    "00794B.TW", "00772B.TW", "00757.TW"
]

ETF_TYPE_MAPPING = {
    "0050.TW": "è‚¡ç¥¨å‹",
    "0056.TW": "é«˜è‚¡æ¯å‹",
    "006208.TW": "è‚¡ç¥¨å‹",
    "00713.TW": "é«˜è‚¡æ¯å‹",
    "00878.TW": "é«˜è‚¡æ¯å‹",
    "00692.TW": "è‚¡ç¥¨å‹",
    "00900.TW": "é«˜è‚¡æ¯å‹",
    "00695B.TW": "å‚µåˆ¸å‹",
    "00794B.TW": "å‚µåˆ¸å‹",
    "00772B.TW": "å‚µåˆ¸å‹",
    "00757.TW": "è‚¡ç¥¨å‹",
}

MARKET_BENCHMARK = "0050.TW"  # å¸‚å ´åŸºæº– ETF

# -------------------------------
# ä½¿ç”¨è€…è¼¸å…¥
# -------------------------------
st.sidebar.header("ğŸ‘¤ ä½¿ç”¨è€…è¨­å®š")
age = st.sidebar.slider("å¹´é½¡", 20, 80, 35)
horizon = st.sidebar.slider("æŠ•è³‡å¹´é™", 1, 40, 10)
loss_tol = st.sidebar.slider("æœ€å¤§å¯æ¥å—æå¤± (%)", 0, 50, 15)
expected_return = st.sidebar.slider("é æœŸå ±é…¬ (%)", 0, 50, 10)
expected_dividend = st.sidebar.slider("æœŸæœ›é…æ¯ (%)", 0, 50, 3)
market_react = st.sidebar.radio("å¸‚å ´ä¸‹è·Œ 20% æ™‚", ["ç«‹å³è³£å‡º", "æŒæœ‰è§€æœ›", "é€¢ä½åŠ ç¢¼"])

# -------------------------------
# Î¸-model è¨ˆç®— (æ•¸æ“šåŒ–)
# åƒè€ƒæ–‡ç»: Grable & Lytton, 1999, Financial Risk Tolerance
# -------------------------------
def calculate_theta(age, horizon, loss_tol, market_react, expected_return, expected_dividend):
    theta = (
        -0.03*(age-40) + 
        0.04*horizon + 
        0.05*(loss_tol-15) + 
        {"ç«‹å³è³£å‡º":-1,"æŒæœ‰è§€æœ›":0,"é€¢ä½åŠ ç¢¼":1.2}[market_react] +
        0.03*expected_return + 
        0.02*expected_dividend
    )
    # å›ºå®šç¯„åœ [-3,3]
    return max(min(round(theta,2),3), -3)

# -------------------------------
# æŠ“ ETF è³‡æ–™
# åŒ…å«åƒ¹æ ¼ã€æ­·å²æ”¶ç›¤ã€è‚¡æ¯ã€æˆäº¤é‡
# -------------------------------
@st.cache_data(ttl=600)
def fetch_etf_info(ticker):
    try:
        yf_ticker = yf.Ticker(ticker)
        hist = yf_ticker.history(period="1y", auto_adjust=True)
        if hist.empty:
            return None

        # è¨ˆç®—éå»ä¸€å¹´ç¸½å ±é…¬ç‡
        price_now = hist["Close"].iloc[-1]
        price_1y_ago = hist["Close"].iloc[0]
        dividends = hist.get("Dividends", pd.Series([0]*len(hist)))
        total_div = dividends.sum()
        total_return = (price_now + total_div)/price_1y_ago - 1

        # å¹´åŒ–é…æ¯ç‡
        ann_div = total_div * 252/len(hist) / price_1y_ago * 100

        # è¿‘ 5 æ—¥å¹³å‡æˆäº¤é‡
        if "Volume" in hist.columns:
            avg_volume = hist["Volume"].tail(5).mean()
        else:
            avg_volume = 0

        return {
            "ä»£ç¢¼": ticker,
            "åç¨±": ticker,
            "å‹æ…‹": ETF_TYPE_MAPPING.get(ticker, "æœªçŸ¥å‹æ…‹"),
            "å³æ™‚åƒ¹": round(price_now,2),
            "å¹´åŒ–é…æ¯ç‡ (%)": round(ann_div,2),
            "éå»ä¸€å¹´ç¸½å ±é…¬ç‡ (%)": round(total_return*100,2),
            "å¹³å‡æˆäº¤é‡": int(avg_volume),
            "æ­·å²åƒ¹æ ¼": hist
        }
    except Exception as e:
        st.warning(f"{ticker} è³‡æ–™æŠ“å–å¤±æ•—: {e}")
        return None

# -------------------------------
# è¨ˆç®— Sharpe Ratio å’Œ Beta
# åƒè€ƒæ–‡ç»: Sharpe, 1966; Lintner, 1965
# -------------------------------
def compute_sharpe_beta(hist, benchmark_hist):
    try:
        # æ¯æ—¥å ±é…¬ç‡
        ret = hist["Close"].pct_change().dropna()
        benchmark_ret = benchmark_hist["Close"].pct_change().dropna()
        # Sharpe Ratio (å¹´åŒ–ï¼Œå‡è¨­ç„¡é¢¨éšªåˆ©ç‡ = 0)
        sharpe = np.sqrt(252) * ret.mean() / ret.std() if ret.std() !=0 else 0
        # Beta
        cov = np.cov(ret, benchmark_ret)
        beta = cov[0,1]/cov[1,1] if cov[1,1]!=0 else 1
        return round(sharpe,2), round(beta,2)
    except:
        return 0,1

# -------------------------------
# ä¸»ç¨‹å¼
# -------------------------------
if st.button("ğŸ“¡ æŠ“å–ç†±é–€ ETF + è¨ˆç®—å€‹äººåŒ–æ¨è–¦"):

    # å…ˆæŠ“å¸‚å ´åŸºæº–
    benchmark_info = fetch_etf_info(MARKET_BENCHMARK)
    if benchmark_info is None:
        st.error("ç„¡æ³•æŠ“å–å¸‚å ´åŸºæº– ETF è³‡æ–™")
    else:
        benchmark_hist = benchmark_info["æ­·å²åƒ¹æ ¼"]

        # æŠ“æ‰€æœ‰ ETF
        etf_list = []
        for t in ETF_LIST:
            info = fetch_etf_info(t)
            if info is None:
                continue
            hist = info["æ­·å²åƒ¹æ ¼"]
            sharpe, beta = compute_sharpe_beta(hist, benchmark_hist)
            info["Sharpe"] = sharpe
            info["Beta"] = beta
            # å€‹äººåŒ–åˆ†æ•¸ = Sharpe èª¿æ•´ Î¸-model
            theta = calculate_theta(age, horizon, loss_tol, market_react, expected_return, expected_dividend)
            info["å€‹äººåŒ–åˆ†æ•¸"] = sharpe - beta*0.5 + theta*0.2
            etf_list.append(info)

        # å»ºç«‹ DataFrame
        df = pd.DataFrame(etf_list)

        # ğŸ”¥ ç†±é–€ ETF æ’åºï¼ˆä¾å¹³å‡æˆäº¤é‡ï¼‰
        st.subheader("ğŸ“ˆ å¸‚å ´ç†±é–€ ETFï¼ˆä¾è¿‘5æ—¥å¹³å‡æˆäº¤é‡ï¼‰")
        df_hot = df.sort_values("å¹³å‡æˆäº¤é‡", ascending=False).head(TOP_N)
        st.dataframe(df_hot[["ä»£ç¢¼","å‹æ…‹","å³æ™‚åƒ¹","å¹³å‡æˆäº¤é‡","Sharpe","Beta"]])

        # ğŸ¯ å€‹äººåŒ–æ¨è–¦æ’åº
        st.subheader("ğŸ¯ å€‹äººåŒ–æ¨è–¦ ETFï¼ˆSharpe + Î¸-modelï¼‰")
        df_sorted = df.sort_values("å€‹äººåŒ–åˆ†æ•¸", ascending=False).head(TOP_N)

        # é¢¨éšªç­‰ç´šå¯è§£é‡‹æ€§
        def score_to_level(s):
            if s>1.0: return "ğŸ”¥ å¾ˆå¥½"
            elif s>0.5: return "ğŸŸ¡ ä¸­ç­‰"
            else: return "ğŸŸ¢ ä¿å®ˆ"
        df_sorted["é¢¨éšªç­‰ç´š"] = df_sorted["Sharpe"].apply(score_to_level)
        st.dataframe(df_sorted[["ä»£ç¢¼","å‹æ…‹","å³æ™‚åƒ¹","Sharpe","Beta","å€‹äººåŒ–åˆ†æ•¸","é¢¨éšªç­‰ç´š"]])

        # å¯è¦–åŒ–ï¼šé›·é”åœ– / æ°£æ³¡åœ–
        st.subheader("ğŸ“Š å€‹äººåŒ–æ¨è–¦è¦–è¦ºåŒ–")
        import plotly.express as px
        radar_df = df_sorted.melt(id_vars=["ä»£ç¢¼"], value_vars=["Sharpe","Beta","å€‹äººåŒ–åˆ†æ•¸"])
        fig = px.line_polar(radar_df, r="value", theta="variable", color="ä»£ç¢¼", line_close=True, markers=True,
                            title="Sharpe / Beta / Î¸-model å€‹äººåŒ–åˆ†æ•¸é›·é”åœ–")
        st.plotly_chart(fig, use_container_width=True)

st.info("ğŸ“Œ è³‡æ–™ä¾†æºï¼šYahoo Financeï½œåƒ…ä¾›åƒè€ƒï¼ŒæŠ•è³‡éœ€è‡ªè² é¢¨éšª")
