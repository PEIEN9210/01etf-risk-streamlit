# -*- coding: utf-8 -*-
"""app.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1Y1jRJvzhlUjdd66vnUOBj57YzwXHYc1s
"""

# app.py
# -*- coding: utf-8 -*-
import streamlit as st
import pandas as pd
import numpy as np
import yfinance as yf
from datetime import datetime, timedelta
import time

st.set_page_config(page_title="ETF Sharpe + Î¸-model å€‹äººåŒ–æ¨è–¦", layout="wide")
st.title("ğŸ“Š å°ç£ç†±é–€ ETF + Sharpe + Î¸-model å€‹äººåŒ–æ¨è–¦")

CACHE_TTL = 300
TOP_N = 5
TRADING_DAYS = 252
MARKET_BENCHMARK = "0050.TW"  # å¸‚å ´åŸºæº– ETF

# -------------------------------
# 1ï¸âƒ£ ä½¿ç”¨è€…è¼¸å…¥
# -------------------------------
cols = st.columns(6)
age = cols[0].slider("ğŸ‘¤ å¹´é½¡", 20, 80, 35)
horizon = cols[1].slider("â³ æŠ•è³‡å¹´é™", 1, 40, 10)
loss_tol = cols[2].slider("ğŸ’¥ æœ€å¤§å¯æ¥å—æå¤± (%)", 0, 50, 15)
expected_return = cols[3].slider("ğŸ¯ é æœŸå ±é…¬ (%)", 0, 50, 10)
expected_dividend = cols[4].slider("ğŸ’° æœŸæœ›é…æ¯ (%)", 0, 50, 3)
market_react = cols[5].radio("ğŸ“‰ å¸‚å ´ä¸‹è·Œ 20%", ["ç«‹å³è³£å‡º","æŒæœ‰è§€æœ›","é€¢ä½åŠ ç¢¼"])

# -------------------------------
# 2ï¸âƒ£ Î¸-model
# -------------------------------
def calculate_theta(age,horizon,loss_tol,market_react,expected_return,expected_dividend):
    theta = (
        -0.03*(age-40) + 0.04*horizon + 0.05*(loss_tol-15)
        + {"ç«‹å³è³£å‡º": -1, "æŒæœ‰è§€æœ›": 0, "é€¢ä½åŠ ç¢¼": 1}[market_react]
        + 0.03*expected_return + 0.02*expected_dividend
    )
    theta_norm = (theta + 2) / 5
    theta_norm = max(0, min(theta_norm,1))
    return theta_norm

theta = calculate_theta(age,horizon,loss_tol,market_react,expected_return,expected_dividend)

# -------------------------------
# 3ï¸âƒ£ ETF å‹æ…‹æ˜ å°„
# -------------------------------
ETF_TYPE_MAPPING = {
    "0050.TW": "è‚¡ç¥¨å‹","0056.TW": "é«˜è‚¡æ¯å‹","006208.TW": "è‚¡ç¥¨å‹",
    "00713.TW": "é«˜è‚¡æ¯å‹","00878.TW": "é«˜è‚¡æ¯å‹","00692.TW": "è‚¡ç¥¨å‹",
    "00900.TW": "é«˜è‚¡æ¯å‹","00695B.TW": "å‚µåˆ¸å‹","00794B.TW": "å‚µåˆ¸å‹",
    "00772B.TW": "å‚µåˆ¸å‹","00757.TW": "è‚¡ç¥¨å‹"
}
TYPE_RISK = {"å‚µåˆ¸å‹":0.2,"é«˜è‚¡æ¯å‹":0.5,"è‚¡ç¥¨å‹":0.8}

# -------------------------------
# 4ï¸âƒ£ TWSE å¹³å‡æˆäº¤é‡ï¼ˆæœ€è¿‘ 1~5 æ—¥ï¼‰
# -------------------------------
@st.cache_data(ttl=CACHE_TTL)
def fetch_twse_avg_volume():
    try:
        url = "https://www.twse.com.tw/exchangeReport/MI_INDEX?response=html&date=&type=ALL"
        tables = pd.read_html(url)
        df = pd.concat(tables, ignore_index=True)
        df.columns = df.columns.str.strip()
        df = df[df["è­‰åˆ¸ä»£è™Ÿ"].str.contains("00")]
        df["æˆäº¤è‚¡æ•¸"] = df["æˆäº¤è‚¡æ•¸"].str.replace(",","").astype(float)
        df["æˆäº¤å‡é‡"] = df["æˆäº¤è‚¡æ•¸"].rolling(5,min_periods=1).mean()
        df["ä»£ç¢¼"] = df["è­‰åˆ¸ä»£è™Ÿ"].astype(str) + ".TW"
        return df[["ä»£ç¢¼","æˆäº¤å‡é‡"]]
    except Exception:
        return pd.DataFrame({
            "ä»£ç¢¼":["0050.TW","0056.TW","006208.TW","00713.TW","00878.TW"],
            "æˆäº¤å‡é‡":[1e6,8e5,5e5,4e5,3e5]
        })

twse_vol = fetch_twse_avg_volume()

# -------------------------------
# 5ï¸âƒ£ æŠ“ Yahoo Finance ETF è³‡æ–™ + Sharpe + Beta
# -------------------------------
@st.cache_data(ttl=CACHE_TTL)
def fetch_etf_info(code, market_benchmark="0050.TW"):
    try:
        ticker = yf.Ticker(code)
        hist = ticker.history(period="1y", actions=True)
        if hist.empty: raise ValueError("No history")
        price_now = hist["Close"].iloc[-1]
        total_div = hist["Dividends"].sum() if "Dividends" in hist.columns else 0.0
        price_1y_ago = hist["Close"].iloc[0]
        total_return = (price_now + total_div)/price_1y_ago -1
        daily_ret = hist["Close"].pct_change().dropna()
        sharpe = (daily_ret.mean()/daily_ret.std()*np.sqrt(TRADING_DAYS)) if daily_ret.std()>0 else 0

        # Beta è¨ˆç®—
        market_hist = yf.Ticker(market_benchmark).history(period="1y")
        market_ret = market_hist["Close"].pct_change().dropna()
        cov = np.cov(daily_ret, market_ret)[0,1]
        beta = cov / np.var(market_ret) if np.var(market_ret)>0 else 1.0

        return {
            "ä»£ç¢¼": code,
            "åç¨±": code,
            "å‹æ…‹": ETF_TYPE_MAPPING.get(code,"æœªçŸ¥å‹æ…‹"),
            "å³æ™‚åƒ¹": round(price_now,2),
            "éå»ä¸€å¹´ç¸½å ±é…¬ç‡ (%)": round(total_return*100,2),
            "Sharpe Ratio": round(sharpe,2),
            "Beta": round(beta,2)
        }
    except Exception:
        return {
            "ä»£ç¢¼": code,
            "åç¨±": code,
            "å‹æ…‹": ETF_TYPE_MAPPING.get(code,"æœªçŸ¥å‹æ…‹"),
            "å³æ™‚åƒ¹": 0.0,
            "éå»ä¸€å¹´ç¸½å ±é…¬ç‡ (%)": 0.0,
            "Sharpe Ratio": 0.0,
            "Beta": 1.0
        }

# -------------------------------
# 6ï¸âƒ£ ç†±é–€ ETF æŒ‰éˆ•
# -------------------------------
if st.button("ğŸ“¡ é¡¯ç¤ºå³æ™‚ç†±é–€ ETF"):
    fallback_list = ["0050.TW","0056.TW","006208.TW","00713.TW","00878.TW",
                     "00692.TW","00900.TW","00695B.TW","00794B.TW","00772B.TW","00757.TW"]
    etf_list = twse_vol["ä»£ç¢¼"].tolist() if not twse_vol.empty else fallback_list
    df_list = [fetch_etf_info(code) for code in etf_list]
    df_hot = pd.DataFrame(df_list)
    df_hot = df_hot.merge(twse_vol, on="ä»£ç¢¼", how="left").fillna({"æˆäº¤å‡é‡":1e5})
    df_hot = df_hot.sort_values("æˆäº¤å‡é‡", ascending=False)
    st.subheader("ğŸ”¥ å³æ™‚ç†±é–€ ETF (ä¾å¹³å‡æˆäº¤é‡æ’åº)")
    st.dataframe(df_hot.head(TOP_N), use_container_width=True)

# -------------------------------
# 7ï¸âƒ£ å€‹äººåŒ–æ¨è–¦æŒ‰éˆ•ï¼ˆSharpe + Beta + Î¸-modelï¼‰
# -------------------------------
if st.button("ğŸš€ è¨ˆç®—å€‹äººåŒ–æ¨è–¦"):
    fallback_list = ["0050.TW","0056.TW","006208.TW","00713.TW","00878.TW",
                     "00692.TW","00900.TW","00695B.TW","00794B.TW","00772B.TW","00757.TW"]
    etf_list = twse_vol["ä»£ç¢¼"].tolist() if not twse_vol.empty else fallback_list
    df_list = [fetch_etf_info(code) for code in etf_list]
    df = pd.DataFrame(df_list)
    df = df.merge(twse_vol, on="ä»£ç¢¼", how="left").fillna({"æˆäº¤å‡é‡":1e5})

    # å€‹äººåŒ–åˆ†æ•¸ = Beta æ ¡æ­£ Sharpe - Î¸åå·®
    sharpe_mean = df["Sharpe Ratio"].mean()
    sharpe_std = df["Sharpe Ratio"].std() if df["Sharpe Ratio"].std()>0 else 1
    df["sharpe_z"] = (df["Sharpe Ratio"] - sharpe_mean)/sharpe_std
    df["ETF_risk_norm"] = df["å‹æ…‹"].map(TYPE_RISK)
    beta_weight = 0.5
    df["personal_score"] = df["sharpe_z"] * (1/df["Beta"]) - beta_weight * abs(theta - df["ETF_risk_norm"])

    def score_to_level(s):
        if s > 1.0: return "ğŸ”¥å¾ˆå¥½"
        elif s > 0.5: return "ğŸŸ¡ä¸­ç­‰"
        else: return "ğŸŸ¢ä¿å®ˆ"
    df["é¢¨éšªç­‰ç´š"] = df["personal_score"].apply(score_to_level)

    st.subheader(f"ğŸ“Š å€‹äººåŒ–æ’åºçµæœï¼ˆÎ¸={theta:.2f}ï¼‰")
    st.dataframe(df.sort_values("personal_score", ascending=False).head(TOP_N), use_container_width=True)

st.info("ğŸ“Œ è³‡æ–™ä¾†æºï¼šTWSE å¹³å‡æˆäº¤é‡ + Yahoo Financeï½œSharpe Ratio: Sharpe, 1966ï½œBeta æ ¡æ­£ï½œÎ¸-model: Shefrin, 2000")
