# -*- coding: utf-8 -*-
"""app.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1Y1jRJvzhlUjdd66vnUOBj57YzwXHYc1s
"""

# app.py
# -*- coding: utf-8 -*-

import streamlit as st
import pandas as pd
import numpy as np
import yfinance as yf
import requests
import time
import matplotlib.pyplot as plt

st.set_page_config(page_title="ETF Sharpe + Î¸ å€‹äººåŒ–æ¨è–¦", layout="wide")
st.title("ğŸ“Š å¸‚å ´ç†±é–€ ETF Ã— Sharpe Ã— Î¸-model å€‹äººåŒ–æ¨è–¦")

# ===============================
# åŸºæœ¬åƒæ•¸
# ===============================
RISK_FREE_RATE = 0.01  # å¹´åŒ–ç„¡é¢¨éšªåˆ©ç‡ï¼ˆå¯æ”¹æˆå°éŠ€å®šå­˜ï¼‰
TRADING_DAYS = 252
MARKET_BENCH = "0050.TW"  # å¸‚å ´åŸºæº–
TOP_N = 8

# ===============================
# STEP 1ï½œæŠ“ TWSE ETF æ—¥æˆäº¤é‡
# ===============================
@st.cache_data(ttl=3600)
def fetch_twse_etf_volume():
    url = "https://www.twse.com.tw/exchangeReport/ETFDaily?response=json"
    try:
        r = requests.get(url, timeout=10)
        data = r.json()["data"]
        cols = ["ä»£è™Ÿ", "åç¨±", "æˆäº¤è‚¡æ•¸"]
        df = pd.DataFrame(data, columns=cols)
        df["æˆäº¤è‚¡æ•¸"] = pd.to_numeric(df["æˆäº¤è‚¡æ•¸"].str.replace(",", ""), errors="coerce")
        df = df.dropna().sort_values("æˆäº¤è‚¡æ•¸", ascending=False)
        df["Ticker"] = df["ä»£è™Ÿ"] + ".TW"
        return df.head(10)
    except:
        return pd.DataFrame()

twse_df = fetch_twse_etf_volume()

st.subheader("ğŸ”¥ ä»Šæ—¥å¸‚å ´ç†±é–€ ETFï¼ˆä¾æˆäº¤é‡ï¼‰")
if twse_df.empty:
    st.warning("âš  ç„¡æ³•å–å¾— TWSE è³‡æ–™ï¼Œå•Ÿç”¨ fallback ETF")
    hot_etfs = ["0050.TW", "00878.TW", "006208.TW"]
else:
    st.dataframe(twse_df[["ä»£è™Ÿ", "åç¨±", "æˆäº¤è‚¡æ•¸"]])
    hot_etfs = twse_df["Ticker"].tolist()

# ===============================
# STEP 2ï½œYahoo Finance + Sharpe + Beta
# ===============================
@st.cache_data(ttl=3600)
def fetch_etf_metrics(tickers):
    records = []

    market = yf.download(MARKET_BENCH, period="1y", progress=False)["Adj Close"]
    market_ret = market.pct_change().dropna()

    for t in tickers:
        try:
            price = yf.download(t, period="1y", progress=False)["Adj Close"]
            ret = price.pct_change().dropna()

            sharpe = (ret.mean() * TRADING_DAYS - RISK_FREE_RATE) / (ret.std() * np.sqrt(TRADING_DAYS))

            beta = np.cov(ret, market_ret)[0][1] / np.var(market_ret)

            records.append({
                "ETF": t,
                "Sharpe": sharpe,
                "Beta": beta,
                "Volatility": ret.std() * np.sqrt(TRADING_DAYS)
            })
        except:
            continue

    return pd.DataFrame(records)

metrics_df = fetch_etf_metrics(hot_etfs)

# ===============================
# STEP 3ï½œÎ¸-modelï¼ˆé€£çºŒã€å¯è§£é‡‹ï¼‰
# ===============================
st.sidebar.header("ğŸ§  æŠ•è³‡äººé¢¨éšªè¨­å®š")

age = st.sidebar.slider("å¹´é½¡", 20, 70, 35)
experience = st.sidebar.slider("æŠ•è³‡å¹´è³‡", 0, 30, 5)
loss = st.sidebar.slider("æœ€å¤§å¯æ¥å—è™§æ (%)", 5, 50, 20)
expect_return = st.sidebar.slider("æœŸæœ›å¹´åŒ–å ±é…¬ (%)", 3, 20, 8)

# æ¨™æº–åŒ–ï¼ˆå­¸è¡“å¸¸è¦‹ä½œæ³•ï¼‰
theta = (
    (1 - age / 70) * 0.25 +
    (experience / 30) * 0.25 +
    (loss / 50) * 0.25 +
    (expect_return / 20) * 0.25
)

st.sidebar.metric("Î¸ é¢¨éšªæ‰¿å—åº¦", round(theta, 2))

# ===============================
# STEP 4ï½œå€‹äººåŒ–æ’åºï¼ˆé‡é»ï¼‰
# ===============================
df = metrics_df.copy()

# Sharpe æ¨™æº–åŒ–
df["Sharpe_z"] = (df["Sharpe"] - df["Sharpe"].mean()) / df["Sharpe"].std()

# Beta åé›¢æ‡²ç½°ï¼ˆå¸‚å ´é¢¨éšªï¼‰
df["Beta_penalty"] = abs(df["Beta"] - 1)

# Î¸ åé›¢ï¼ˆç”¨æ³¢å‹•ç‡ proxyï¼‰
df["ETF_risk_norm"] = (df["Volatility"] - df["Volatility"].min()) / (
    df["Volatility"].max() - df["Volatility"].min()
)

df["Theta_gap"] = abs(theta - df["ETF_risk_norm"])

# â­ æœ€çµ‚å€‹äººåŒ–åˆ†æ•¸ï¼ˆå­¸è¡“ MCDAï¼‰
df["Personal_Score"] = (
    df["Sharpe_z"]
    - 1.5 * df["Beta_penalty"]
    - 3.0 * df["Theta_gap"]
)

df = df.sort_values("Personal_Score", ascending=False)

st.subheader("ğŸ¯ å€‹äººåŒ– ETF æ¨è–¦æ’åº")
st.dataframe(df[["ETF", "Sharpe", "Beta", "Personal_Score"]])

# ===============================
# STEP 5ï½œè¦–è¦ºåŒ–ï¼ˆç‚ºä»€éº¼ä¸åŒï¼‰
# ===============================
st.subheader("ğŸ“ˆ ç‚ºä»€éº¼æ¨è–¦ä¸åŒï¼Ÿï¼ˆæ°£æ³¡åœ–ï¼‰")

fig, ax = plt.subplots()
scatter = ax.scatter(
    df["Beta"],
    df["Sharpe"],
    s=(1 - df["Theta_gap"]) * 800,
    alpha=0.7
)

for _, row in df.iterrows():
    ax.text(row["Beta"], row["Sharpe"], row["ETF"], fontsize=9)

ax.set_xlabel("Betaï¼ˆå¸‚å ´é¢¨éšªï¼‰")
ax.set_ylabel("Sharpe Ratio")
ax.axvline(1, linestyle="--", alpha=0.4)
ax.set_title("Sharpe Ã— Beta Ã— Î¸ åé›¢é‡ï¼ˆæ°£æ³¡è¶Šå¤§ï¼è¶Šç¬¦åˆä½ ï¼‰")

st.pyplot(fig)
