# -*- coding: utf-8 -*-
"""app.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1Y1jRJvzhlUjdd66vnUOBj57YzwXHYc1s
"""

# app.py
# -*- coding: utf-8 -*-

import streamlit as st
import pandas as pd
import numpy as np
import yfinance as yf
import requests
from datetime import datetime

st.set_page_config(page_title="å°ç£ ETF æ™ºæ…§æ’åº", layout="wide")
st.title("ğŸ“Š å°ç£ç†±é–€ ETF + å€‹äººåŒ–é¢¨éšªæ’åºï¼ˆç©©å®šç‰ˆï¼‰")

CACHE_TTL = 600

# ===============================
# 1ï¸âƒ£ ç†±é–€ ETF
# ===============================
def fetch_hot_etf():
    return [
        "0050.TW","0056.TW","006208.TW","00713.TW","00878.TW",
        "00692.TW","00900.TW","00695B.TW","00794B.TW","00772B.TW"
    ]

# ===============================
# 2ï¸âƒ£ ETF å‹æ…‹
# ===============================
ETF_TYPE_MAPPING = {
    "0050.TW": "è‚¡ç¥¨å‹",
    "0056.TW": "é«˜è‚¡æ¯å‹",
    "006208.TW": "è‚¡ç¥¨å‹",
    "00713.TW": "é«˜è‚¡æ¯å‹",
    "00878.TW": "é«˜è‚¡æ¯å‹",
    "00692.TW": "è‚¡ç¥¨å‹",
    "00900.TW": "é«˜è‚¡æ¯å‹",
    "00695B.TW": "å‚µåˆ¸å‹",
    "00794B.TW": "å‚µåˆ¸å‹",
    "00772B.TW": "å‚µåˆ¸å‹",
}

# ===============================
# 3ï¸âƒ£ TWSE ETF åˆ†é…æ”¶ç›Š
# ===============================
@st.cache_data(ttl=CACHE_TTL)
def fetch_twse_etf_dividend():
    url = "https://www.twse.com.tw/rwd/zh/ETF/etfDiv"
    params = {"response": "json", "date": datetime.now().strftime("%Y%m%d")}

    try:
        r = requests.get(url, params=params, timeout=10)
        r.raise_for_status()
        data = r.json().get("data", [])
        if not data:
            return pd.DataFrame(columns=["ä»£è™Ÿ","åç¨±","åˆ†é…æ”¶ç›Š","é™¤æ¯äº¤æ˜“æ—¥"])
        df = pd.DataFrame(data, columns=[
            "ä»£è™Ÿ","åç¨±","åˆ†é…æ”¶ç›Š","é™¤æ¯äº¤æ˜“æ—¥",
            "æ”¶ç›Šåˆ†é…ç™¼æ”¾æ—¥","æ”¶ç›Šåˆ†é…æ‰€å±¬æœŸé–“"
        ])
        df["åˆ†é…æ”¶ç›Š"] = pd.to_numeric(df["åˆ†é…æ”¶ç›Š"], errors="coerce")
        return df.dropna(subset=["åˆ†é…æ”¶ç›Š"])
    except:
        return pd.DataFrame(columns=["ä»£è™Ÿ","åç¨±","åˆ†é…æ”¶ç›Š","é™¤æ¯äº¤æ˜“æ—¥"])

# ===============================
# 4ï¸âƒ£ ETF è©³ç´°è³‡è¨Š
# ===============================
@st.cache_data(ttl=CACHE_TTL)
def fetch_etf_info(code, div_df):
    etf_type = ETF_TYPE_MAPPING.get(code, "æœªçŸ¥å‹æ…‹")
    price_now = price_1y_ago = 0
    annual_div = latest_div = 0
    latest_date = "N/A"

    try:
        if etf_type != "å‚µåˆ¸å‹":
            # è‚¡ç¥¨å‹ / é«˜è‚¡æ¯å‹ ETF æŠ“ Yahoo Finance æ­·å²ä¸€å¹´
            ticker = yf.Ticker(code)
            hist = ticker.history(period="1y")
            if not hist.empty:
                price_now = hist["Close"].iloc[-1]
                price_1y_ago = hist["Close"].iloc[0]
                dividends = hist.get("Dividends", pd.Series()).fillna(0)
                annual_div = dividends.sum()
                recent = dividends[dividends>0]
                if not recent.empty:
                    latest_div = recent.iloc[-1]
                    latest_date = recent.index[-1].strftime("%Y-%m-%d")
        else:
            # å‚µåˆ¸å‹ ETF å…¨éƒ¨ç”¨ TWSE è³‡æ–™
            rows = div_df[div_df["ä»£è™Ÿ"]==code.replace(".TW","")]
            if not rows.empty:
                latest = rows.iloc[0]
                annual_div = rows["åˆ†é…æ”¶ç›Š"].sum()
                latest_div = latest["åˆ†é…æ”¶ç›Š"]
                latest_date = latest["é™¤æ¯äº¤æ˜“æ—¥"]
                # å–æœ€è¿‘ 5 æ—¥æ”¶ç›¤åƒ¹ä½œç‚ºè¿‘ä¼¼åƒ¹æ ¼
                ticker = yf.Ticker(code)
                hist = ticker.history(period="5d")
                if not hist.empty:
                    price_now = hist["Close"].iloc[-1]
                    price_1y_ago = price_now  # é¿å…é™¤é›¶ï¼Œç”¨è¿‘ä¼¼å€¼

    except Exception as e:
        st.warning(f"ETF {code} è³‡æ–™æŠ“å–å¤±æ•—: {e}")

    annual_yield = (annual_div / price_1y_ago * 100) if price_1y_ago else 0
    total_return = ((price_now + annual_div) / price_1y_ago - 1) * 100 if price_1y_ago else 0

    return {
        "ä»£ç¢¼": code,
        "å‹æ…‹": etf_type,
        "å³æ™‚åƒ¹": round(price_now,2),
        "å¹´åŒ–é…æ¯ç‡ (%)": round(annual_yield,2),
        "æœ€æ–°é™¤æ¯é‡‘é¡": round(latest_div,2),
        "æœ€æ–°é™¤æ¯æ—¥": latest_date,
        "éå»ä¸€å¹´ç¸½å ±é…¬ç‡ (%)": round(total_return,2)
    }

# ===============================
# 5ï¸âƒ£ ETF é¢¨éšªæŒ‡æ•¸
# ===============================
def compute_etf_risk_index(row):
    type_risk = {"å‚µåˆ¸å‹":0.2,"é«˜è‚¡æ¯å‹":0.5,"è‚¡ç¥¨å‹":0.8}.get(row["å‹æ…‹"],0.6)
    return round(
        0.4 * type_risk
        + 0.3 * (100 - row["éå»ä¸€å¹´ç¸½å ±é…¬ç‡ (%)"]) * 0.01
        + 0.3 * (100 - row["å¹´åŒ–é…æ¯ç‡ (%)"]) * 0.01,
        3
    )

# ===============================
# UI
# ===============================
if st.button("ğŸ“¡ æŠ“ç†±é–€ ETF æœ€æ–°è³‡è¨Š"):
    div_df = fetch_twse_etf_dividend()
    results = []

    for code in fetch_hot_etf():
        # âœ… è‚¡ç¥¨å‹ ETF é™é€Ÿï¼Œå‚µåˆ¸å‹ ETF ä¸æŠ“æ­·å²ä¸€å¹´
        if ETF_TYPE_MAPPING.get(code) != "å‚µåˆ¸å‹":
            import time
            time.sleep(1.5)
        info = fetch_etf_info(code, div_df)
        results.append(info)

    df = pd.DataFrame(results)
    df["é¢¨éšªæŒ‡æ•¸"] = df.apply(compute_etf_risk_index, axis=1)
    st.dataframe(df, use_container_width=True)

st.info("ğŸ“Œ å‚µåˆ¸ ETF è³‡æ–™ä¾†æºï¼šå°ç£è­‰äº¤æ‰€ TWSEï½œå…¶é¤˜ï¼šYahoo Finance")
