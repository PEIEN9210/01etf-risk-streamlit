# -*- coding: utf-8 -*-
"""app.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1Y1jRJvzhlUjdd66vnUOBj57YzwXHYc1s
"""

# app.py
# -*- coding: utf-8 -*-

import streamlit as st
import pandas as pd
import numpy as np
import yfinance as yf
from datetime import datetime, timedelta

# -----------------------------
# Streamlit åŸºæœ¬è¨­å®š
# -----------------------------
st.set_page_config(page_title="ETF Sharpe + Î¸-model å€‹äººåŒ–æ¨è–¦", layout="wide")
st.title("ğŸ“Š ETF ç†±é–€æ’è¡Œ Ã— Sharpe Ã— Î¸-model å€‹äººåŒ–æ¨è–¦")

TRADING_DAYS = 252
RISK_FREE_RATE = 0.015  # å¹´åŒ–ç„¡é¢¨éšªåˆ©ç‡ï¼ˆå¯èª¿ï¼‰

# -----------------------------
# ETF åå–®ï¼ˆå¯è‡ªè¡Œæ“´å……ï¼‰
# -----------------------------
ETF_LIST = {
    "0050.TW": "è‚¡ç¥¨å‹",
    "006208.TW": "è‚¡ç¥¨å‹",
    "00692.TW": "è‚¡ç¥¨å‹",
    "00757.TW": "è‚¡ç¥¨å‹",
    "0056.TW": "é«˜è‚¡æ¯å‹",
}

MARKET_BENCHMARK = "0050.TW"

# -----------------------------
# è³‡æ–™æŠ“å–ï¼ˆYahoo Financeï¼‰
# -----------------------------
@st.cache_data(ttl=600)
def fetch_etf_data(ticker):
    try:
        yf_ticker = yf.Ticker(ticker)
        hist = yf_ticker.history(period="1y", auto_adjust=True)
        info = yf_ticker.fast_info

        if hist.empty:
            return None

        return {
            "price": hist["Close"],
            "avg_volume": info.get("averageVolume", np.nan),
        }
    except Exception:
        return None

# -----------------------------
# Sharpe Ratio
# -----------------------------
def calculate_sharpe(price_series):
    returns = price_series.pct_change().dropna()
    if returns.std() == 0 or returns.empty:
        return np.nan

    annual_return = returns.mean() * TRADING_DAYS
    annual_vol = returns.std() * np.sqrt(TRADING_DAYS)
    return (annual_return - RISK_FREE_RATE) / annual_vol

# -----------------------------
# Betaï¼ˆå°å¸‚å ´ï¼‰
# -----------------------------
def calculate_beta(asset_returns, market_returns):
    df = pd.concat([asset_returns, market_returns], axis=1).dropna()
    if df.shape[0] < 30:
        return np.nan

    cov = np.cov(df.iloc[:, 0], df.iloc[:, 1])[0][1]
    var = np.var(df.iloc[:, 1])
    return cov / var if var != 0 else np.nan

# -----------------------------
# Î¸-modelï¼ˆå¯è§£é‡‹ï¼‰
# -----------------------------
def calculate_theta(age, experience, max_drawdown):
    """
    Î¸ âˆˆ [0, 1]
    è¶Šæ¥è¿‘ 1 = è¶Šèƒ½æ‰¿æ“”é¢¨éšª
    """
    age_score = np.clip((65 - age) / 45, 0, 1)
    exp_score = np.clip(experience / 20, 0, 1)
    dd_score = np.clip(max_drawdown / 50, 0, 1)

    theta = 0.4 * age_score + 0.3 * exp_score + 0.3 * dd_score
    return round(theta, 3)

# -----------------------------
# Sharpe ç­‰ç´š
# -----------------------------
def sharpe_level(sr):
    if sr >= 1.0:
        return "ğŸ”¥ å¾ˆå¥½"
    elif sr >= 0.5:
        return "ğŸŸ¡ ä¸­ç­‰"
    else:
        return "âš  åå¼±"

# =============================
# ä½¿ç”¨è€…è¼¸å…¥ï¼ˆÎ¸-modelï¼‰
# =============================
st.sidebar.header("ğŸ‘¤ æŠ•è³‡äººé¢¨éšªå±¬æ€§")

age = st.sidebar.slider("å¹´é½¡", 20, 70, 35)
experience = st.sidebar.slider("æŠ•è³‡å¹´è³‡ï¼ˆå¹´ï¼‰", 0, 30, 5)
max_dd = st.sidebar.slider("å¯æ¥å—æœ€å¤§è™§æ (%)", 5, 60, 20)

theta = calculate_theta(age, experience, max_dd)

st.sidebar.markdown(f"""
### ğŸ¯ æŠ•è³‡äºº Î¸ å€¼
**Î¸ = {theta}**

- Î¸ â†’ 1ï¼šåç©æ¥µ  
- Î¸ â†’ 0ï¼šåä¿å®ˆ  
""")

# =============================
# æŠ“å¸‚å ´åŸºæº–
# =============================
benchmark_data = fetch_etf_data(MARKET_BENCHMARK)
benchmark_returns = benchmark_data["price"].pct_change().dropna()

# =============================
# ä¸»æµç¨‹
# =============================
rows = []

for ticker, etf_type in ETF_LIST.items():
    data = fetch_etf_data(ticker)
    if data is None:
        continue

    price = data["price"]
    returns = price.pct_change().dropna()

    sharpe = calculate_sharpe(price)
    beta = calculate_beta(returns, benchmark_returns)

    rows.append({
        "ETF": ticker,
        "é¡å‹": etf_type,
        "Sharpe Ratio": sharpe,
        "Beta": beta,
        "å¹³å‡æˆäº¤é‡ï¼ˆProxyï¼‰": data["avg_volume"],
        "Sharpe ç­‰ç´š": sharpe_level(sharpe),
    })

df = pd.DataFrame(rows).dropna()

# =============================
# ğŸ”¥ ç†±é–€ ETFï¼ˆå…ˆåšï¼‰
# =============================
st.subheader("ğŸ”¥ å¸‚å ´ç†±é–€ ETFï¼ˆä¾å¹³å‡æˆäº¤é‡ Proxyï¼‰")

hot_df = df.sort_values("å¹³å‡æˆäº¤é‡ï¼ˆProxyï¼‰", ascending=False)
st.dataframe(hot_df, use_container_width=True)

# =============================
# ğŸ¯ å€‹äººåŒ–æ’åºï¼ˆSharpe Ã— Î¸ Ã— Beta åé›¢ï¼‰
# =============================
st.subheader("ğŸ¯ å€‹äººåŒ–æ¨è–¦æ’åºï¼ˆSharpe + Î¸-modelï¼‰")

df["é¢¨éšªåé›¢"] = abs(df["Beta"] - theta)
df["å€‹äººåŒ–åˆ†æ•¸"] = df["Sharpe Ratio"] - df["é¢¨éšªåé›¢"]

personal_df = df.sort_values("å€‹äººåŒ–åˆ†æ•¸", ascending=False)

st.markdown("""
**æ’åºé‚è¼¯ï¼ˆå¯è¿½æº¯ï¼‰**  
- ä¸»æ’åºï¼šSharpe Ratioï¼ˆå ±é…¬ / æ³¢å‹•ï¼‰  
- æ ¡æ­£ï¼š| Beta âˆ’ Î¸ |ï¼ˆå¸‚å ´é¢¨éšªæ˜¯å¦ç¬¦åˆæŠ•è³‡äººï¼‰  
- åˆ†æ•¸ = Sharpe âˆ’ åé›¢æ‡²ç½°  
""")

st.dataframe(personal_df, use_container_width=True)

# =============================
# çµå°¾èªªæ˜
# =============================
st.info("""
ğŸ“š **æ–¹æ³•è«–èªªæ˜ï¼ˆå­¸è¡“ä¸€è‡´ï¼‰**

- Sharpe Ratioï¼šSharpe (1966)  
- Beta / å¸‚å ´é¢¨éšªï¼šCAPMï¼ˆSharpe, Lintnerï¼‰  
- æµå‹•æ€§ Proxyï¼šAmihud (2002)  
- Î¸-modelï¼šè¡Œç‚ºé¢¨éšªé‡åŒ–ï¼ˆå¯è§£é‡‹ã€éé»‘ç®±ï¼‰

æœ¬ç³»çµ±é¿å…ä¾è³´äº¤æ˜“æ‰€å³æ™‚ APIï¼Œç¢ºä¿ **å¯é‡ç¾æ€§èˆ‡é›²ç«¯ç©©å®šæ€§**ã€‚
""")
