# -*- coding: utf-8 -*-
"""app.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1Y1jRJvzhlUjdd66vnUOBj57YzwXHYc1s
"""

# app.py
# -*- coding: utf-8 -*-

import streamlit as st
import pandas as pd
import numpy as np
import yfinance as yf
import altair as alt
from datetime import datetime, timedelta

# ===============================
# åŸºæœ¬è¨­å®š
# ===============================
st.set_page_config(page_title="å°ç£ ETF å€‹äººåŒ–æ¨è–¦ç³»çµ±", layout="wide")
st.title("ğŸ“Š å°ç£ ETF å€‹äººåŒ– + HotIndex ETF æ¨è–¦ç³»çµ± (Top N è‡ªå‹•æ›´æ–°)")

TRADING_DAYS = 252
RISK_FREE_RATE = 0.01  # ç„¡é¢¨éšªåˆ©ç‡

# ===============================
# ETF Universe & å¸‚å ´åŸºæº–
# ===============================
ETF_LIST = {
    "0050.TW": "è‚¡ç¥¨å‹",
    "006208.TW": "è‚¡ç¥¨å‹",
    "00692.TW": "è‚¡ç¥¨å‹",
    "00757.TW": "è‚¡ç¥¨å‹",
    "0056.TW": "é«˜è‚¡æ¯å‹",
    "00878.TW": "é«˜è‚¡æ¯å‹",
    "00919.TW": "é«˜è‚¡æ¯å‹",
}
MARKET_BENCHMARK = "0050.TW"

# ===============================
# Sidebarï¼šä½¿ç”¨è€…è¨­å®š
# ===============================
st.sidebar.header("ğŸ‘¤ æŠ•è³‡äººé¢¨éšªè¨­å®š")

age = st.sidebar.slider(
    "å¹´é½¡", 20, 80, 35, key="age_slider"
)

horizon = st.sidebar.slider(
    "æŠ•è³‡å¹´é™ï¼ˆå¹´ï¼‰", 1, 30, 10, key="horizon_slider"
)

loss_tol = st.sidebar.slider(
    "å¯æ¥å—æœ€å¤§æå¤± (%)", 0, 50, 20, key="loss_tol_slider"
)

reaction = st.sidebar.radio(
    "å¸‚å ´ä¸‹è·Œ 20% æ™‚",
    ["è³£å‡º", "è§€æœ›", "åŠ ç¢¼"],
    key="reaction_radio"
)


# ===============================
# Î¸-modelï¼šBehavioral Risk Aversion Proxy
# ===============================

# å¹´é½¡ï¼šéç·šæ€§ç”Ÿå‘½é€±æœŸæ•ˆæœï¼ˆä¸­å£¯å¹´é¢¨éšªæ‰¿æ“”è¼ƒé«˜ï¼‰
age_score = np.exp(-((age - 35) ** 2) / 450)

# æŠ•è³‡å¹´é™ï¼šé‚Šéš›æ•ˆç”¨éæ¸›
horizon_score = np.log1p(horizon) / np.log1p(30)

# å¿ƒç†å¯æ¥å—æå¤±ï¼ˆç›´æ¥æ­éœ²é¢¨éšªå®¹å¿ï¼‰
loss_score = loss_tol / 50

# ä¸‹è·Œæ™‚è¡Œç‚ºåæ‡‰ï¼ˆrevealed preferenceï¼‰
reaction_score = {
    "è³£å‡º": 0.0,
    "è§€æœ›": 0.5,
    "åŠ ç¢¼": 1.0
}[reaction]

# Î¸ åŠ æ¬Šæ•´åˆï¼ˆå¿ƒç† > è¡Œç‚º > äººå£èƒŒæ™¯ï¼‰
theta_raw = (
    0.35 * loss_score +
    0.25 * reaction_score +
    0.20 * age_score +
    0.20 * horizon_score
)

theta = np.clip(theta_raw, 0, 1)

st.sidebar.metric("Î¸ï¼ˆé¢¨éšªåå¥½æŒ‡æ•¸ï¼‰", round(theta,2))

# HotIndex vs å€‹äººåŒ–åˆ†æ•¸æ¬Šé‡
st.sidebar.header("âš–ï¸ ç¶œåˆåˆ†æ•¸æ¬Šé‡")
ALPHA = st.sidebar.slider(
    "HotIndex æ¬Šé‡ï¼ˆå€‹äººåŒ–åˆ†æ•¸æ¬Šé‡ = 1 - HotIndex æ¬Šé‡ï¼‰",
    0.0, 1.0, 0.5, step=0.05
)
st.sidebar.write(f"HotIndex æ¬Šé‡: {ALPHA:.2f} | å€‹äººåŒ–åˆ†æ•¸æ¬Šé‡: {1-ALPHA:.2f}")

# Top N é¡¯ç¤º
st.sidebar.header("ğŸ“ˆ Top N ETF é¡¯ç¤º")
TOP_N = st.sidebar.slider("Top N ETF", 1, len(ETF_LIST), 5)

# ===============================
# æŠ“å–åƒ¹æ ¼è³‡æ–™ï¼ˆå«æ¯æ—¥è‡ªå‹•åˆ·æ–°ï¼‰
# ===============================
@st.cache_data(ttl=86400)  # æ¯å¤©è‡ªå‹•æ›´æ–°ä¸€æ¬¡
def fetch_price_data(code, period="1y"):
    df = yf.Ticker(code).history(period=period)
    if df.empty or len(df) < 50:
        return None
    return df

# ===============================
# æŒ‡æ¨™è¨ˆç®—
# ===============================
def calc_metrics(df, market_df):
    r = df["Close"].pct_change().dropna()
    mr = market_df["Close"].pct_change().dropna()
    idx = r.index.intersection(mr.index)
    r, mr = r.loc[idx], mr.loc[idx]

    ann_ret = r.mean() * TRADING_DAYS
    ann_vol = r.std() * np.sqrt(TRADING_DAYS)
    sharpe = (ann_ret - RISK_FREE_RATE)/ann_vol if ann_vol>0 else 0
    beta = np.cov(r,mr)[0,1]/np.var(mr)
    return ann_ret*100, ann_vol*100, sharpe, beta

def compute_hot_index(df, window=20):
    volume_ma = df["Volume"].rolling(window).mean().iloc[-1]
    returns = df["Close"].pct_change()
    volatility = returns.rolling(window).std().iloc[-1]
    flow_proxy = (df["Close"]*df["Volume"]).rolling(window).mean().iloc[-1]
    return {"volume_score":volume_ma, "volatility":volatility, "flow_proxy":flow_proxy}

def robust_zscore(series):
    med = np.median(series)
    mad = np.median(np.abs(series - med))
    if mad==0:
        return pd.Series(0,index=series.index)
    return (series - med)/mad

# ===============================
# ä¸»æµç¨‹ï¼šè¨ˆç®— ETF åˆ†æ•¸
# ===============================
market_df = fetch_price_data(MARKET_BENCHMARK)
rows = []

for etf, etf_type in ETF_LIST.items():
    df = fetch_price_data(etf)
    if df is None or market_df is None:
        continue

    ann_ret, ann_vol, sharpe, beta = calc_metrics(df, market_df)

    # å€‹äººåŒ–é©é…
    expected_return = 5 + theta*20
    acceptable_vol = 10 + theta*25
    ideal_beta = 0.7 + theta*0.8

    sharpe_fit = min(sharpe/3,1)
    return_fit = np.clip(1 - abs(ann_ret-expected_return)/expected_return,0,1)
    vol_fit = np.clip(1 - ann_vol/acceptable_vol,0,1)
    beta_fit = np.clip(1 - abs(beta-ideal_beta)/ideal_beta,0,1)
    personal_score = np.mean([sharpe_fit, return_fit, vol_fit, beta_fit])

    # HotIndex
    hot_metrics = compute_hot_index(df)
    row = {
        "ETF":etf,
        "é¡å‹":etf_type,
        "æœ€æ–°åƒ¹":round(df["Close"].iloc[-1],2),
        "Sharpe":round(sharpe,2),
        "Beta":round(beta,2),
        "å¹´åŒ–å ±é…¬%":round(ann_ret,2),
        "å¹´åŒ–æ³¢å‹•%":round(ann_vol,2),
        "å€‹äººåŒ–åˆ†æ•¸":round(personal_score,3),
        "volume_score":hot_metrics["volume_score"],
        "volatility":hot_metrics["volatility"],
        "flow_proxy":hot_metrics["flow_proxy"],
        "Sharpeé©é…":round(sharpe_fit,2),
        "å ±é…¬é©é…":round(return_fit,2),
        "æ³¢å‹•é©é…":round(vol_fit,2),
        "Betaé©é…":round(beta_fit,2)
    }
    rows.append(row)

df_all = pd.DataFrame(rows)

# HotIndex z-score
for col in ["volume_score","volatility","flow_proxy"]:
    df_all[col+"_z"] = robust_zscore(df_all[col])
df_all["hot_index"] = df_all[["volume_score_z","volatility_z","flow_proxy_z"]].sum(axis=1)

# æœ€çµ‚ç¶œåˆåˆ†æ•¸
df_all["final_score"] = ALPHA*df_all["hot_index"] + (1-ALPHA)*df_all["å€‹äººåŒ–åˆ†æ•¸"]
df_all = df_all.sort_values("final_score",ascending=False)
df_all_top = df_all.head(TOP_N)

# ===============================
# è¡¨æ ¼é¡¯ç¤º
# ===============================
st.subheader(f"ğŸ¯ Top {TOP_N} ETF æ’åºï¼ˆHotIndex + å€‹äººåŒ–åˆ†æ•¸ï¼‰")
st.dataframe(df_all_top[[
    "ETF","é¡å‹","æœ€æ–°åƒ¹","Sharpe","Beta","å¹´åŒ–å ±é…¬%","å¹´åŒ–æ³¢å‹•%",
    "å€‹äººåŒ–åˆ†æ•¸","hot_index","final_score"
]],use_container_width=True)

# ===============================
# é›·é”åœ–
# ===============================
st.subheader(f"ğŸ“¡ Top {TOP_N} ETF é›·é”åœ–ï¼ˆé©é…åº¦ï¼‰")
metrics = ["Sharpeé©é…","å ±é…¬é©é…","æ³¢å‹•é©é…","Betaé©é…"]
radar = df_all_top.melt(id_vars="ETF",value_vars=metrics,var_name="æŒ‡æ¨™",value_name="å€¼")
radar["order"] = radar["æŒ‡æ¨™"].map({m:i for i,m in enumerate(metrics)})
radar["è§’åº¦"] = radar["order"]*2*np.pi/len(metrics)
radar["x"] = radar["å€¼"]*np.cos(radar["è§’åº¦"])
radar["y"] = radar["å€¼"]*np.sin(radar["è§’åº¦"])
radar_closed = pd.concat([radar, radar.groupby("ETF").apply(lambda d:d.iloc[[0]]).reset_index(drop=True)],ignore_index=True)

area = alt.Chart(radar_closed).mark_area(opacity=0.3).encode(
    x=alt.X("x:Q",axis=None),
    y=alt.Y("y:Q",axis=None),
    color="ETF:N",
    detail="ETF:N",
    order="order:Q",
    tooltip=["ETF","æŒ‡æ¨™","å€¼"]
)
line = alt.Chart(radar_closed).mark_line().encode(
    x="x:Q",
    y="y:Q",
    color="ETF:N",
    detail="ETF:N",
    order="order:Q"
)
labels = pd.DataFrame({
    "æŒ‡æ¨™":metrics,
    "x":[1.2*np.cos(i*2*np.pi/len(metrics)) for i in range(len(metrics))],
    "y":[1.2*np.sin(i*2*np.pi/len(metrics)) for i in range(len(metrics))]
})
text = alt.Chart(labels).mark_text(fontSize=12).encode(x="x:Q",y="y:Q",text="æŒ‡æ¨™:N")
st.altair_chart(area+line+text,use_container_width=True)

# ===============================
# æ°£æ³¡åœ–
# ===============================
st.subheader(f"ğŸ«§ Top {TOP_N} ETF æ°£æ³¡åœ–ï¼ˆSharpe Ã— å€‹äººåŒ–åˆ†æ•¸ Ã— Betaï¼‰")
bubble = alt.Chart(df_all_top).mark_circle(opacity=0.7,stroke="black",strokeWidth=0.5).encode(
    x=alt.X("Sharpe:Q", title="Sharpe Ratio", scale=alt.Scale(zero=False)),
    y=alt.Y("å€‹äººåŒ–åˆ†æ•¸:Q", title="å€‹äººåŒ–åˆ†æ•¸", scale=alt.Scale(zero=True)),
    size=alt.Size("Beta:Q", title="Beta", scale=alt.Scale(range=[100,1600])),
    color=alt.Color("é¡å‹:N", title="ETF é¡å‹"),
    tooltip=["ETF","Sharpe","Beta","å€‹äººåŒ–åˆ†æ•¸","hot_index","final_score"]
)
st.altair_chart(bubble,use_container_width=True)
