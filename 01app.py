# -*- coding: utf-8 -*-
"""app.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1Y1jRJvzhlUjdd66vnUOBj57YzwXHYc1s
"""

# app.py
# -*- coding: utf-8 -*-

import streamlit as st
import pandas as pd
import numpy as np
import yfinance as yf
import altair as alt

st.set_page_config(page_title="ETF å€‹äººåŒ–æ¨è–¦ç³»çµ±", layout="wide")
st.title("ğŸ“Š ETF å€‹äººåŒ–æ¨è–¦ï¼ˆSharpe Ã— Beta Ã— Î¸-modelï¼‰")

# ===============================
# åŸºæœ¬è¨­å®š
# ===============================
ETF_LIST = [
    "0050.TW","0056.TW","00878.TW","006208.TW",
    "00713.TW","00900.TW","00692.TW",
    "00695B.TW","00794B.TW","00772B.TW"
]

ETF_TYPE = {
    "0050.TW":"è‚¡ç¥¨å‹","0056.TW":"é«˜è‚¡æ¯","00878.TW":"é«˜è‚¡æ¯",
    "006208.TW":"è‚¡ç¥¨å‹","00713.TW":"é«˜è‚¡æ¯","00900.TW":"é«˜è‚¡æ¯",
    "00692.TW":"è‚¡ç¥¨å‹",
    "00695B.TW":"å‚µåˆ¸å‹","00794B.TW":"å‚µåˆ¸å‹","00772B.TW":"å‚µåˆ¸å‹"
}

RISK_FREE = 0.017
TRADING_DAYS = 252
TOP_N = 5

# ===============================
# ä½¿ç”¨è€…è¼¸å…¥ï¼ˆÎ¸-modelï¼‰
# ===============================
st.subheader("ğŸ‘¤ æŠ•è³‡äººé¢¨éšªè¨­å®š")

c1,c2,c3,c4,c5,c6 = st.columns(6)
age = c1.slider("å¹´é½¡",20,80,35)
years = c2.slider("æŠ•è³‡å¹´é™",1,40,10)
loss = c3.slider("æœ€å¤§å¯æ¥å—è™§æ %",0,50,15)
ret = c4.slider("é æœŸå ±é…¬ %",0,40,10)
div = c5.slider("æœŸæœ›é…æ¯ %",0,20,4)
reaction = c6.radio("å¸‚å ´ä¸‹è·Œ 20%",["ææ…Œè³£å‡º","è§€æœ›","åŠ ç¢¼"])

def theta_model(age,years,loss,ret,div,reaction):
    reaction_map = {"ææ…Œè³£å‡º":-1,"è§€æœ›":0,"åŠ ç¢¼":1.2}
    theta = (
        -0.03*(age-40)
        +0.05*years
        +0.04*(loss-15)
        +0.04*ret
        +0.03*div
        +reaction_map[reaction]
    )
    return float(np.clip(theta/2, -2, 2))

theta = theta_model(age,years,loss,ret,div,reaction)
st.info(f"ğŸ¯ æŠ•è³‡äºº Î¸ï¼ˆé¢¨éšªæ‰¿å—åº¦ï¼‰ï¼š**{theta}**  ï¼ˆ-2 ä¿å®ˆ â†’ +2 ç©æ¥µï¼‰")

# ===============================
# ETF è³‡æ–™ï¼ˆYahoo Financeï¼‰
# ===============================
@st.cache_data(ttl=300)
def fetch_etfs():
    rows = []
    market = yf.Ticker("0050.TW").history(period="1y")["Close"].pct_change()

    for code in ETF_LIST:
        try:
            t = yf.Ticker(code)
            h = t.history(period="1y")
            if h.empty: continue

            r = h["Close"].pct_change().dropna()
            mu = r.mean()*TRADING_DAYS
            sigma = r.std()*np.sqrt(TRADING_DAYS)
            sharpe = (mu-RISK_FREE)/sigma if sigma>0 else 0

            beta = np.cov(r, market.loc[r.index])[0,1]/market.var()

            rows.append({
                "ETF":code,
                "é¡å‹":ETF_TYPE.get(code,"æœªçŸ¥"),
                "Sharpe":round(sharpe,2),
                "Beta":round(beta,2),
                "å¹´åŒ–å ±é…¬%":round(mu*100,2),
                "å¹´åŒ–æ³¢å‹•%":round(sigma*100,2)
            })
        except:
            pass
    return pd.DataFrame(rows)

df = fetch_etfs()

if df.empty:
    st.error("âŒ ç„¡æ³•å–å¾— ETF è³‡æ–™")
    st.stop()

# ===============================
# ç†±é–€ ETFï¼ˆSharpeï¼‰
# ===============================
st.subheader("ğŸ”¥ å¸‚å ´ç†±é–€ ETFï¼ˆSharpe æ’åºï¼‰")
df_hot = df.sort_values("Sharpe",ascending=False)
st.dataframe(df_hot.reset_index(drop=True))

# ===============================
# å€‹äººåŒ–æ’åºï¼ˆæ ¸å¿ƒï¼‰
# ===============================
def personal_score(row,theta):
    """
    Sharpe ç‚ºä¸»
    èˆ‡æŠ•è³‡äºº Î¸ çš„ Beta è·é›¢ä½œæ‡²ç½°
    """
    return row["Sharpe"] - abs(theta-row["Beta"])

df["å€‹äººåŒ–åˆ†æ•¸"] = df.apply(lambda r: personal_score(r,theta),axis=1)
df_p = df.sort_values("å€‹äººåŒ–åˆ†æ•¸",ascending=False)

st.subheader("ğŸ¯ å€‹äººåŒ–æ¨è–¦ ETF")
st.dataframe(df_p.head(TOP_N).reset_index(drop=True))

# ===============================
# ğŸ¯ çœŸãƒ»é›·é”åœ–ï¼ˆå°é–‰å¤šé‚Šå½¢ï¼‰
# ===============================
st.subheader("ğŸ“¡ æ¨è–¦ ETF é›·é”åœ–ï¼ˆSharpe / å ±é…¬ / æ³¢å‹• / Betaï¼‰")

radar = df_p.head(3).copy()
metrics = ["Sharpe","å¹´åŒ–å ±é…¬%","å¹´åŒ–æ³¢å‹•%","Beta"]

radar_long = radar.melt(
    id_vars=["ETF"],
    value_vars=metrics,
    var_name="æŒ‡æ¨™",
    value_name="å€¼"
)

# å°é–‰å¤šé‚Šå½¢
radar_long["è§’åº¦"] = radar_long.groupby("ETF").cumcount()
radar_long["è§’åº¦"] = radar_long["è§’åº¦"].astype(str)

radar_chart = alt.Chart(radar_long).mark_line(
    closed=True,
    point=True
).encode(
    theta=alt.Theta("è§’åº¦:N", sort=metrics),
    radius=alt.Radius("å€¼:Q", scale=alt.Scale(zero=True)),
    color="ETF:N",
    tooltip=["ETF","æŒ‡æ¨™","å€¼"]
)

st.altair_chart(radar_chart,use_container_width=True)

# ===============================
# ğŸ’¥ æ°£æ³¡åœ–ï¼ˆç‚ºä»€éº¼æ¨è–¦ï¼‰
# ===============================
st.subheader("ğŸ’¥ æ¨è–¦è§£é‡‹æ°£æ³¡åœ–")

bubble = df.copy()
bubble["Î¸å·®è·"] = abs(theta-bubble["Beta"])

bubble_chart = alt.Chart(bubble).mark_circle(opacity=0.7).encode(
    x=alt.X("Sharpe", title="Sharpe Ratio"),
    y=alt.Y("Î¸å·®è·", title="èˆ‡æŠ•è³‡äºº Î¸ è·é›¢"),
    size=alt.Size("Beta", scale=alt.Scale(range=[200,1500])),
    color="é¡å‹",
    tooltip=["ETF","Sharpe","Beta","Î¸å·®è·"]
)

st.altair_chart(bubble_chart,use_container_width=True)

st.caption("ğŸ“š Sharpe (1966), CAPM, Grable & Lytton (1999), Weber et al. (2002)")
