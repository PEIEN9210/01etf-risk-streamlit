# -*- coding: utf-8 -*-
"""app.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1Y1jRJvzhlUjdd66vnUOBj57YzwXHYc1s
"""

# app.py
# -*- coding: utf-8 -*-

import streamlit as st
import pandas as pd
import numpy as np
import yfinance as yf
import plotly.express as px
import plotly.graph_objects as go

# =========================
# åŸºæœ¬è¨­å®š
# =========================
st.set_page_config(page_title="Sharpe + Î¸-model å€‹äººåŒ– ETF æ¨è–¦", layout="wide")
st.title("ğŸ“Š Sharpe + Î¸-model å¯è§£é‡‹å€‹äººåŒ– ETF æ¨è–¦ç³»çµ±")

st.caption("""
ğŸ“š ç†è«–åŸºç¤ï¼š
- Sharpe Ratioï¼ˆSharpe, 1966ï¼‰
- Beta / CAPMï¼ˆSharpe, 1964ï¼‰
- æµå‹•æ€§ proxyï¼ˆAmihud, 2002ï¼‰
- è¡Œç‚ºé¢¨éšªæ•¸å€¼åŒ–ï¼ˆBehavioral Financeï¼‰
""")

# =========================
# ETF Universeï¼ˆå°ç£ä¸»æµï¼‰
# =========================
ETF_LIST = [
    "0050.TW", "0056.TW", "006208.TW", "00878.TW",
    "00713.TW", "00919.TW", "00929.TW",
    "00679B.TWO", "00772B.TWO"
]

MARKET_INDEX = "^TWII"

# =========================
# å·¥å…·å‡½æ•¸
# =========================

@st.cache_data(ttl=3600)
def fetch_hot_etfs(tickers, top_n=5):
    """ä»¥ Yahoo Finance å¹³å‡æˆäº¤é‡ä½œç‚ºæµå‹•æ€§ proxy
    æ–‡ç»ï¼šAmihud (2002), Fama & French (2015)
    """
    rows = []

    for t in tickers:
        try:
            info = yf.Ticker(t).info
            rows.append({
                "ticker": t,
                "name": info.get("shortName", t),
                "avg_volume": info.get("averageVolume", 0)
            })
        except:
            continue

    df = pd.DataFrame(rows)
    df = df.sort_values("avg_volume", ascending=False)
    return df.head(top_n)


@st.cache_data(ttl=3600)
def calculate_metrics(ticker, market):
    """Sharpe Ratio èˆ‡ Beta è¨ˆç®—
    Sharpe (1966), CAPM
    """
    price = yf.download(ticker, period="1y", progress=False)["Adj Close"]
    market_price = yf.download(market, period="1y", progress=False)["Adj Close"]

    ret = price.pct_change().dropna()
    mkt_ret = market_price.pct_change().dropna()

    ret, mkt_ret = ret.align(mkt_ret, join="inner")

    sharpe = (ret.mean() / ret.std()) * np.sqrt(252)
    beta = np.cov(ret, mkt_ret)[0, 1] / np.var(mkt_ret)

    return sharpe, beta


def theta_model(age, experience, max_loss):
    """Î¸-modelï¼šå°‡æŠ•è³‡äººé¢¨éšªåå¥½æ•¸å€¼åŒ–ï¼ˆå¯è§£é‡‹ï¼‰
    éé»‘ç®±ï¼Œå°æ‡‰è¡Œç‚ºé‡‘è
    """
    age_score = max(0, 1 - age / 70)
    exp_score = min(experience / 10, 1)
    loss_score = min(max_loss / 50, 1)

    theta = 0.4 * age_score + 0.3 * exp_score + 0.3 * loss_score
    return theta


def personalized_score(sharpe, beta, theta):
    """æ ¸å¿ƒæ’åºå…¬å¼
    Sharpe âˆ’ |Beta âˆ’ Î¸|
    """
    return sharpe - abs(beta - theta)


# =========================
# ä½¿ç”¨è€…è¼¸å…¥ï¼ˆÎ¸-modelï¼‰
# =========================
st.sidebar.header("ğŸ‘¤ æŠ•è³‡äººé¢¨éšªè¨­å®š")

age = st.sidebar.slider("å¹´é½¡", 20, 70, 35)
experience = st.sidebar.slider("æŠ•è³‡å¹´è³‡ï¼ˆå¹´ï¼‰", 0, 20, 5)
max_loss = st.sidebar.slider("æœ€å¤§å¯æ¥å—è™§æ (%)", 5, 50, 20)

theta = theta_model(age, experience, max_loss)

st.sidebar.markdown(f"**Î¸ é¢¨éšªå€¼ï¼š `{theta:.2f}`**")

# =========================
# ç†±é–€ ETF
# =========================
st.header("ğŸ”¥ å¸‚å ´ç†±é–€ ETFï¼ˆä¾å¹³å‡æˆäº¤é‡ï¼‰")

hot_df = fetch_hot_etfs(ETF_LIST, top_n=5)
st.dataframe(hot_df, use_container_width=True)

# =========================
# è¨ˆç®—æŒ‡æ¨™
# =========================
records = []

for _, row in hot_df.iterrows():
    sharpe, beta = calculate_metrics(row["ticker"], MARKET_INDEX)
    score = personalized_score(sharpe, beta, theta)

    records.append({
        "ETF": row["name"],
        "Ticker": row["ticker"],
        "Sharpe": sharpe,
        "Beta": beta,
        "Î¸": theta,
        "å€‹äººåŒ–åˆ†æ•¸": score
    })

df = pd.DataFrame(records)
df = df.sort_values("å€‹äººåŒ–åˆ†æ•¸", ascending=False)

# =========================
# æ’åºçµæœ
# =========================
st.header("ğŸ† å€‹äººåŒ– ETF æ¨è–¦æ’åº")

st.dataframe(
    df.style.format({
        "Sharpe": "{:.2f}",
        "Beta": "{:.2f}",
        "Î¸": "{:.2f}",
        "å€‹äººåŒ–åˆ†æ•¸": "{:.2f}"
    }),
    use_container_width=True
)

# =========================
# ğŸ“Š æ°£æ³¡åœ–ï¼ˆSharpe Ã— Beta Ã— åˆ†æ•¸ï¼‰
# =========================
st.header("ğŸ“Š ETF é¢¨éšª Ã— å ±é…¬ Ã— å€‹äººåŒ–åˆ†æ•¸ï¼ˆæ°£æ³¡åœ–ï¼‰")

fig_bubble = px.scatter(
    df,
    x="Beta",
    y="Sharpe",
    size="å€‹äººåŒ–åˆ†æ•¸",
    color="ETF",
    hover_data=["å€‹äººåŒ–åˆ†æ•¸"],
    title="Sharpe Ã— Beta Ã— å€‹äººåŒ–æ¨è–¦å¼·åº¦"
)

st.plotly_chart(fig_bubble, use_container_width=True)

# =========================
# ğŸ“Š é›·é”åœ–ï¼ˆå‰ä¸‰åï¼‰
# =========================
st.header("ğŸ“ Top 3 ETF æŒ‡æ¨™é›·é”åœ–")

top3 = df.head(3)

for _, r in top3.iterrows():
    fig = go.Figure()

    fig.add_trace(go.Scatterpolar(
        r=[r["Sharpe"], 1 - abs(r["Beta"] - theta), r["å€‹äººåŒ–åˆ†æ•¸"]],
        theta=["Sharpe", "é¢¨éšªé©é…åº¦", "å€‹äººåŒ–åˆ†æ•¸"],
        fill='toself',
        name=r["ETF"]
    ))

    fig.update_layout(
        polar=dict(radialaxis=dict(visible=True)),
        showlegend=True,
        title=r["ETF"]
    )

    st.plotly_chart(fig, use_container_width=True)
