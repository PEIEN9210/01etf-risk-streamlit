# -*- coding: utf-8 -*-
"""app.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1Y1jRJvzhlUjdd66vnUOBj57YzwXHYc1s
"""

# app.py
# -*- coding: utf-8 -*-

import streamlit as st
import pandas as pd
import numpy as np
import yfinance as yf
import plotly.graph_objects as go
import altair as alt
import statsmodels.api as sm

st.set_page_config(page_title="å°ç£ ETF å€‹äººåŒ–æ¨è–¦ç³»çµ±", layout="wide")

# ===============================
# Page State
# ===============================
if "page" not in st.session_state:
    st.session_state.page = "main"

st.sidebar.title("ETF åˆ†æå·¥å…·")
if st.sidebar.button("ğŸ“Š åŸºæœ¬ ETF åˆ†æ"):
    st.session_state.page = "main"
if st.sidebar.button("ğŸ§  ETF é¢¨éšªå› å­åˆ†æ"):
    st.session_state.page = "factor"

# ===============================
# åŸºæœ¬è¨­å®š
# ===============================
st.title("ğŸ“Š å°ç£ ETF å€‹äººåŒ– + ç†±é–€ ETF å¤šæº–å‰‡è³‡ç”¢æ’åºæ¡†æ¶ (åƒ…ä¾›åƒè€ƒï¼Œä¸è² æŠ•è³‡é¢¨éšª:)")

TRADING_DAYS = 252
RISK_FREE_RATE = 0.01

ETF_LIST = {
    "0050.TW": "è‚¡ç¥¨å‹",
    "006208.TW": "è‚¡ç¥¨å‹",
    "00692.TW": "è‚¡ç¥¨å‹",
    "00757.TW": "è‚¡ç¥¨å‹",
    "0056.TW": "é«˜è‚¡æ¯å‹",
    "00878.TW": "é«˜è‚¡æ¯å‹",
    "00919.TW": "é«˜è‚¡æ¯å‹",
}
MARKET_BENCHMARK = "0050.TW"

# ===============================
# Sidebarï¼šé¢¨éšªåå¥½
# ===============================
st.sidebar.header("ğŸ‘¤ æŠ•è³‡äººé¢¨éšªè¨­å®š")
age = st.sidebar.slider("å¹´é½¡", 20, 80, 35)
horizon = st.sidebar.slider("æŠ•è³‡å¹´é™ï¼ˆå¹´ï¼‰", 1, 30, 10)
loss_tol = st.sidebar.slider("å¯æ¥å—æœ€å¤§æå¤± (%)", 0, 50, 20)
reaction = st.sidebar.radio("å¸‚å ´ä¸‹è·Œ 20% æ™‚", ["è³£å‡º", "è§€æœ›", "åŠ ç¢¼"])

theta = ((80 - age)/60 + horizon/30 + loss_tol/50 + {"è³£å‡º":0,"è§€æœ›":0.5,"åŠ ç¢¼":1}[reaction]) / 4
theta = np.clip(theta, 0, 1)
st.sidebar.metric("Î¸ï¼ˆé¢¨éšªåå¥½æŒ‡æ•¸ï¼‰", round(theta, 2))

def alpha_from_theta(theta, a_min=0.1, a_max=0.7):
    return a_min + (a_max - a_min) * theta

ALPHA_MODEL = alpha_from_theta(theta)

# ===============================
# è³‡æ–™æŠ“å–
# ===============================
@st.cache_data(ttl=86400)
def fetch_all_price_data(etf_list, benchmark, period="1y"):
    data = {}
    for code in set(list(etf_list.keys()) + [benchmark]):
        df = yf.Ticker(code).history(period=period)
        if not df.empty:
            data[code] = df
    return data

price_data = fetch_all_price_data(ETF_LIST, MARKET_BENCHMARK)
market_df = price_data.get(MARKET_BENCHMARK)

# ===============================
# æŒ‡æ¨™å‡½æ•¸
# ===============================
def calc_metrics(df, market_df):
    r = df["Close"].pct_change().dropna()
    mr = market_df["Close"].pct_change().dropna()
    idx = r.index.intersection(mr.index)
    r, mr = r.loc[idx], mr.loc[idx]
    ann_ret = r.mean() * TRADING_DAYS
    ann_vol = r.std() * np.sqrt(TRADING_DAYS)
    sharpe = (ann_ret - RISK_FREE_RATE) / ann_vol if ann_vol > 0 else 0
    beta = np.cov(r, mr)[0,1] / np.var(mr)
    return ann_ret*100, ann_vol*100, sharpe, beta

def robust_zscore(series):
    med = np.median(series)
    mad = np.median(np.abs(series - med))
    return (series - med) / mad if mad != 0 else 0

# ===============================
# ä¸»è³‡æ–™è¡¨å»ºç«‹ï¼ˆä¸€æ¬¡ï¼‰
# ===============================
rows = []
for etf, etf_type in ETF_LIST.items():
    df = price_data.get(etf)
    if df is None or market_df is None:
        continue
    ann_ret, ann_vol, sharpe, beta = calc_metrics(df, market_df)
    rows.append({
        "ETF": etf,
        "é¡å‹": etf_type,
        "Sharpe": sharpe,
        "Beta": beta,
        "å¹´åŒ–å ±é…¬%": ann_ret,
        "å¹´åŒ–æ³¢å‹•%": ann_vol
    })

df_all = pd.DataFrame(rows)

# ===============================
# å› å­åˆ†æé 
# ===============================
def load_factor_data(freq="M"):
    mkt = yf.Ticker("^TWII").history(period="10y")
    mkt["MKT"] = mkt["Close"].pct_change()
    factors = mkt[["MKT"]].dropna()
    factors["SMB"] = 0.0
    factors["HML"] = 0.0
    factors["RF"] = RISK_FREE_RATE / TRADING_DAYS
    return factors.resample(freq).last()

def run_factor_regression(etf_code, freq):
    etf_df = yf.Ticker(etf_code).history(period="10y")
    etf_ret = etf_df["Close"].pct_change().dropna().to_frame("ETF")
    if freq == "M":
        etf_ret = etf_ret.resample("M").last()
    factors = load_factor_data(freq)
    data = etf_ret.join(factors, how="inner")
    Y = data["ETF"] - data["RF"]
    X = sm.add_constant(data[["MKT","SMB","HML"]])
    return sm.OLS(Y, X).fit()

def show_factor_page():
    st.title("ğŸ§  ETF é¢¨éšªå› å­åˆ†æ")
    etf = st.selectbox("é¸æ“‡ ETF", list(ETF_LIST.keys()))
    freq = st.radio("è³‡æ–™é »ç‡", ["æ—¥è³‡æ–™","æœˆè³‡æ–™"])
    if st.button("é–‹å§‹å› å­å›æ­¸åˆ†æ"):
        model = run_factor_regression(etf, "D" if freq=="æ—¥è³‡æ–™" else "M")
        st.text(model.summary())

# ===============================
# Page Router
# ===============================
if st.session_state.page == "main":
    st.dataframe(df_all, use_container_width=True)
elif st.session_state.page == "factor":
    show_factor_page()
