# -*- coding: utf-8 -*-
"""app.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1Y1jRJvzhlUjdd66vnUOBj57YzwXHYc1s
"""

# 01app.py
# -*- coding: utf-8 -*-

import streamlit as st
import pandas as pd
import numpy as np
import yfinance as yf
import altair as alt
import requests
from datetime import datetime, timedelta

# =============================
# åŸºæœ¬è¨­å®š
# =============================
st.set_page_config(page_title="ETF å€‹äººåŒ–é¢¨éšªæ¨è–¦ç³»çµ±", layout="wide")
st.title("ğŸ“Š ETF ç†±é–€æ’åº + Sharpe Ã— Î¸-model å€‹äººåŒ–æ¨è–¦")

TRADING_DAYS = 252
RISK_FREE_RATE = 0.01  # å¹´åŒ–ç„¡é¢¨éšªåˆ©ç‡ï¼ˆå­¸è¡“å¸¸ç”¨å‡è¨­ï¼‰

# =============================
# å·¥å…·å‡½æ•¸
# =============================

@st.cache_data(ttl=3600)
def fetch_twse_etf_volume(days=3):
    """
    æŠ“å– TWSE æœ€è¿‘ N å€‹äº¤æ˜“æ—¥ ETF æˆäº¤é‡
    è‹¥å¤±æ•—å‰‡å›å‚³ç©º DataFrameï¼ˆfallbackï¼‰
    """
    all_days = []
    today = datetime.today()

    for i in range(days * 2):
        date = (today - timedelta(days=i)).strftime("%Y%m%d")
        url = (
            "https://www.twse.com.tw/exchangeReport/ETFDaily"
            f"?response=json&date={date}"
        )
        try:
            r = requests.get(url, timeout=5)
            data = r.json()
            if data.get("stat") != "OK":
                continue

            df = pd.DataFrame(data["data"], columns=data["fields"])
            df = df[["è­‰åˆ¸ä»£è™Ÿ", "æˆäº¤è‚¡æ•¸"]]
            df["æˆäº¤è‚¡æ•¸"] = pd.to_numeric(df["æˆäº¤è‚¡æ•¸"].str.replace(",", ""), errors="coerce")
            all_days.append(df)
        except Exception:
            continue

        if len(all_days) >= days:
            break

    if not all_days:
        return pd.DataFrame()

    vol_df = pd.concat(all_days)
    return (
        vol_df
        .groupby("è­‰åˆ¸ä»£è™Ÿ")["æˆäº¤è‚¡æ•¸"]
        .mean()
        .reset_index()
        .rename(columns={"æˆäº¤è‚¡æ•¸": "è¿‘Næ—¥å¹³å‡æˆäº¤é‡"})
        .sort_values("è¿‘Næ—¥å¹³å‡æˆäº¤é‡", ascending=False)
    )


@st.cache_data(ttl=3600)
def fetch_price_data(ticker, period="1y"):
    try:
        df = yf.download(ticker, period=period, auto_adjust=True, progress=False)
        if df.empty:
            return None
        return df
    except Exception:
        return None


def compute_sharpe(returns):
    if returns.std() == 0:
        return np.nan
    return (
        (returns.mean() * TRADING_DAYS - RISK_FREE_RATE)
        / (returns.std() * np.sqrt(TRADING_DAYS))
    )


def compute_beta(asset_ret, market_ret):
    cov = np.cov(asset_ret, market_ret)[0][1]
    var = np.var(market_ret)
    if var == 0:
        return np.nan
    return cov / var


def theta_score(age, exp_years, max_loss):
    """
    æ•¸æ“šåŒ– Î¸-modelï¼ˆ0~1ï¼‰
    åƒè€ƒè¡Œç‚ºé‡‘èé¢¨éšªæ‰¿å—åº¦é‡è¡¨ï¼ˆGrable & Lyttonï¼‰
    """
    age_score = np.clip((60 - age) / 40, 0, 1)
    exp_score = np.clip(exp_years / 20, 0, 1)
    loss_score = np.clip(max_loss / 50, 0, 1)

    theta = 0.4 * age_score + 0.3 * exp_score + 0.3 * loss_score
    return round(theta, 3)


# =============================
# STEP 1ï¼šç†±é–€ ETFï¼ˆå…ˆé¡¯ç¤ºï¼‰
# =============================
st.header("ğŸ”¥ å³æ™‚ç†±é–€ ETFï¼ˆä¾ TWSE è¿‘ N æ—¥å¹³å‡æˆäº¤é‡ï¼‰")

days = st.slider("è¨ˆç®—è¿‘å¹¾å€‹äº¤æ˜“æ—¥å¹³å‡æˆäº¤é‡", 1, 5, 3)

vol_df = fetch_twse_etf_volume(days)

if vol_df.empty:
    st.warning("âš  ç„¡æ³•å–å¾— TWSE æˆäº¤é‡è³‡æ–™ï¼Œæ”¹ç”¨é è¨­ ETF æ¸…å–®")
    hot_etfs = ["0050.TW", "006208.TW", "0056.TW", "00692.TW"]
else:
    hot_etfs = vol_df["è­‰åˆ¸ä»£è™Ÿ"].head(10).apply(lambda x: f"{x}.TW").tolist()
    st.dataframe(vol_df.head(10), use_container_width=True)

# =============================
# STEP 2ï¼šä½¿ç”¨è€… Î¸-model è¼¸å…¥
# =============================
st.header("ğŸ§  æŠ•è³‡äººé¢¨éšªå±¬æ€§ï¼ˆÎ¸-modelï¼‰")

col1, col2, col3 = st.columns(3)

with col1:
    age = st.slider("å¹´é½¡", 18, 70, 35)

with col2:
    exp_years = st.slider("æŠ•è³‡å¹´è³‡ï¼ˆå¹´ï¼‰", 0, 30, 5)

with col3:
    max_loss = st.slider("å¯æ¥å—æœ€å¤§è™§æ (%)", 5, 50, 20)

theta = theta_score(age, exp_years, max_loss)
st.success(f"ğŸ¯ Î¸ å€¼ï¼ˆ0~1ï¼‰ï¼š{theta}")

# =============================
# STEP 3ï¼šè¨ˆç®— Sharpe / Beta
# =============================
st.header("ğŸ“ Sharpe Ã— Beta Ã— å€‹äººåŒ–æ’åº")

market_df = fetch_price_data("0050.TW")

results = []

for etf in hot_etfs:
    price_df = fetch_price_data(etf)
    if price_df is None or market_df is None:
        continue

    ret = price_df["Close"].pct_change().dropna()
    mkt_ret = market_df["Close"].pct_change().dropna()

    aligned = ret.align(mkt_ret, join="inner")
    if len(aligned[0]) < 60:
        continue

    sharpe = compute_sharpe(aligned[0])
    beta = compute_beta(aligned[0], aligned[1])

    results.append({
        "ETF": etf,
        "Sharpe": sharpe,
        "Beta": beta
    })

df = pd.DataFrame(results).dropna()

# =============================
# STEP 4ï¼šÎ¸ Ã— Sharpe å€‹äººåŒ–åˆ†æ•¸
# =============================
df["Sharpe_norm"] = (df["Sharpe"] - df["Sharpe"].min()) / (df["Sharpe"].max() - df["Sharpe"].min())
df["Beta_penalty"] = abs(df["Beta"] - (1 + theta))
df["Personal_Score"] = df["Sharpe_norm"] * (1 - df["Beta_penalty"].clip(0, 1))

df = df.sort_values("Personal_Score", ascending=False)

st.dataframe(
    df[["ETF", "Sharpe", "Beta", "Personal_Score"]],
    use_container_width=True
)

# =============================
# STEP 5ï¼šè¦–è¦ºåŒ–ï¼ˆAltairï¼‰
# =============================
st.subheader("ğŸ“Š ç‚ºä»€éº¼æ¨è–¦ä¸åŒï¼Ÿï¼ˆå¯è§£é‡‹è¦–è¦ºåŒ–ï¼‰")

chart = (
    alt.Chart(df)
    .mark_circle(opacity=0.7)
    .encode(
        x=alt.X("Beta:Q", title="Betaï¼ˆå¸‚å ´é¢¨éšªï¼‰"),
        y=alt.Y("Sharpe:Q", title="Sharpe Ratio"),
        size=alt.Size("Personal_Score:Q", title="å€‹äººåŒ–åˆ†æ•¸", scale=alt.Scale(range=[200, 1200])),
        color=alt.Color("Personal_Score:Q", scale=alt.Scale(scheme="viridis")),
        tooltip=["ETF", "Sharpe", "Beta", "Personal_Score"]
    )
    .properties(height=450)
)

st.altair_chart(chart, use_container_width=True)

st.caption("ğŸ“š Sharpe Ratioï¼ˆSharpe, 1966ï¼‰ã€Betaï¼ˆCAPMï¼‰ã€Î¸-modelï¼ˆè¡Œç‚ºé‡‘èé¢¨éšªæ‰¿å—åº¦ï¼‰")
