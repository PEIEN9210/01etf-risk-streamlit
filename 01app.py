# -*- coding: utf-8 -*-
"""app.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1Y1jRJvzhlUjdd66vnUOBj57YzwXHYc1s
"""

# app.py
# -*- coding: utf-8 -*-

import streamlit as st
import pandas as pd
import numpy as np
import yfinance as yf
import altair as alt
from datetime import datetime, timedelta
from scipy.stats import spearmanr

# ===============================
# åŸºæœ¬è¨­å®š
# ===============================
st.set_page_config(page_title="å°ç£ ETF å€‹äººåŒ–æ¨è–¦ç³»çµ±", layout="wide")
st.title("ğŸ“Š å°ç£ ETF å€‹äººåŒ– + HotIndex ETF æ¨è–¦ç³»çµ± (åƒ…ä¾›åƒè€ƒï¼Œä¸è² æŠ•è³‡é¢¨éšª:)")

TRADING_DAYS = 252
RISK_FREE_RATE = 0.01

# Sharpe çš„ã€Œé™ç´šæ¬Šé‡ã€ï¼ˆè«–æ–‡å®‰å…¨ï¼‰
SHARPE_GAMMA = 0.1   # â† æ˜ç¢ºå®£å‘Šï¼šSharpe éæ ¸å¿ƒï¼Œåªæ˜¯ä¿®æ­£è¨Šè™Ÿ

# ===============================
# ETF Universe & å¸‚å ´åŸºæº–
# ===============================
ETF_LIST = {
    "0050.TW": "è‚¡ç¥¨å‹",
    "006208.TW": "è‚¡ç¥¨å‹",
    "00692.TW": "è‚¡ç¥¨å‹",
    "00757.TW": "è‚¡ç¥¨å‹",
    "0056.TW": "é«˜è‚¡æ¯å‹",
    "00878.TW": "é«˜è‚¡æ¯å‹",
    "00919.TW": "é«˜è‚¡æ¯å‹",
}
MARKET_BENCHMARK = "0050.TW"

# ===============================
# Sidebarï¼šä½¿ç”¨è€…è¨­å®š
# ===============================
st.sidebar.header("ğŸ‘¤ æŠ•è³‡äººé¢¨éšªè¨­å®š")
age = st.sidebar.slider("å¹´é½¡", 20, 80, 35)
horizon = st.sidebar.slider("æŠ•è³‡å¹´é™ï¼ˆå¹´ï¼‰", 1, 30, 10)
loss_tol = st.sidebar.slider("å¯æ¥å—æœ€å¤§æå¤± (%)", 0, 50, 20)
reaction = st.sidebar.radio("å¸‚å ´ä¸‹è·Œ 20% æ™‚", ["è³£å‡º", "è§€æœ›", "åŠ ç¢¼"])

theta = ((80-age)/60 + horizon/30 + loss_tol/50 + {"è³£å‡º":0,"è§€æœ›":0.5,"åŠ ç¢¼":1}[reaction])/4
theta = np.clip(theta,0,1)
st.sidebar.metric("Î¸ï¼ˆé¢¨éšªåå¥½æŒ‡æ•¸ï¼‰", round(theta,2))

# ===============================
# HotIndex vs å€‹äººåŒ–åˆ†æ•¸æ¬Šé‡
# ===============================
st.sidebar.header("âš–ï¸ ç¶œåˆåˆ†æ•¸æ¬Šé‡")
ALPHA = st.sidebar.slider("HotIndex æ¬Šé‡", 0.0, 1.0, 0.5, step=0.05)
st.sidebar.write(f"HotIndex: {ALPHA:.2f} | å€‹äººåŒ–: {1-ALPHA:.2f}")

# ===============================
# è³‡æ–™æŠ“å–
# ===============================
@st.cache_data(ttl=86400)
def fetch_price_data(code, period="1y"):
    df = yf.Ticker(code).history(period=period)
    if df.empty or len(df) < 50:
        return None
    return df

# ===============================
# æè¿°æ€§æŒ‡æ¨™ï¼ˆéæ’åºæ ¸å¿ƒï¼‰
# ===============================
def calc_metrics(df, market_df):
    r = df["Close"].pct_change().dropna()
    mr = market_df["Close"].pct_change().dropna()
    idx = r.index.intersection(mr.index)
    r, mr = r.loc[idx], mr.loc[idx]

    ann_ret = r.mean() * TRADING_DAYS
    ann_vol = r.std() * np.sqrt(TRADING_DAYS)
    sharpe = (ann_ret - RISK_FREE_RATE)/ann_vol if ann_vol > 0 else 0
    beta = np.cov(r, mr)[0,1] / np.var(mr)
    return ann_ret*100, ann_vol*100, sharpe, beta

# ===============================
# HotIndexï¼ˆå¸‚å ´ç†±åº¦ proxyï¼‰
# ===============================
def compute_hot_index(df, window=20):
    volume_ma = df["Volume"].rolling(window).mean().iloc[-1]
    volatility = df["Close"].pct_change().rolling(window).std().iloc[-1]
    flow_proxy = (df["Close"] * df["Volume"]).rolling(window).mean().iloc[-1]
    return volume_ma + flow_proxy - volatility

# ===============================
# Î¸ åå¥½é©é…ï¼ˆæ±ºç­–æ ¸å¿ƒï¼‰
# ===============================
def compute_preference_fit(ann_ret, ann_vol, sharpe, beta, theta):
    expected_return = 5 + theta * 20
    acceptable_vol = 10 + theta * 25
    ideal_beta = 0.7 + theta * 0.8

    return_fit = np.clip(1 - abs(ann_ret - expected_return)/expected_return, 0, 1)
    vol_fit = np.clip(1 - ann_vol/acceptable_vol, 0, 1)
    beta_fit = np.clip(1 - abs(beta - ideal_beta)/ideal_beta, 0, 1)

    # Sharpeï¼šåªä½œç‚ºç©©å®šæ€§ä¿®æ­£ï¼ˆéå°ç¨±ã€ä½æ¬Šé‡ï¼‰
    sharpe_fit = np.clip(sharpe / 3, 0, 1)

    core_fit = np.mean([return_fit, vol_fit, beta_fit])
    personal_score = (1 - SHARPE_GAMMA) * core_fit + SHARPE_GAMMA * sharpe_fit

    return {
        "personal_score": personal_score,
        "return_fit": return_fit,
        "vol_fit": vol_fit,
        "beta_fit": beta_fit,
        "sharpe_fit": sharpe_fit
    }

# ===============================
# ä¸»æµç¨‹ï¼šè¨ˆç®—æ’åº
# ===============================
market_df = fetch_price_data(MARKET_BENCHMARK)
rows = []

for etf, etf_type in ETF_LIST.items():
    df = fetch_price_data(etf)
    if df is None or market_df is None:
        continue

    ann_ret, ann_vol, sharpe, beta = calc_metrics(df, market_df)
    pref = compute_preference_fit(ann_ret, ann_vol, sharpe, beta, theta)
    hot_index = compute_hot_index(df)

    final_score = ALPHA * hot_index + (1 - ALPHA) * pref["personal_score"]

    rows.append({
        "ETF": etf,
        "é¡å‹": etf_type,
        "å¹´åŒ–å ±é…¬%": round(ann_ret,2),
        "å¹´åŒ–æ³¢å‹•%": round(ann_vol,2),
        "Beta": round(beta,2),
        "Sharpe": round(sharpe,2),
        "personal_score": round(pref["personal_score"],3),
        "final_score": round(final_score,3),
        **pref
    })

df_all = pd.DataFrame(rows).sort_values("final_score", ascending=False)

# ===============================
# UI
# ===============================
st.subheader(f"ğŸ¯ ETF æ’åºçµæœï¼ˆÎ¸={round(theta,2)}ï¼‰")
st.dataframe(df_all, use_container_width=True)
