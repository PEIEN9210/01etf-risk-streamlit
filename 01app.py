# -*- coding: utf-8 -*-
"""app.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1Y1jRJvzhlUjdd66vnUOBj57YzwXHYc1s
"""

# app.py
# -*- coding: utf-8 -*-

import streamlit as st
import pandas as pd
import requests
from datetime import datetime
import yfinance as yf
import time

st.set_page_config(page_title="å°ç£ ETF ç†±é–€æ’è¡Œ + æ™ºæ…§é¢¨éšªæ’åº", layout="wide")
st.title("ğŸ“ˆ è‡ªå‹•ç†±é–€ ETF æ’å + é¢¨éšªæŒ‡æ•¸æ¯”è¼ƒ")

# ===============================
# 1ï¸âƒ£ æŠ“å– TWSE ETF æ—¥æˆäº¤è³‡è¨Š
# ===============================
@st.cache_data(ttl=600)
def fetch_twse_etf_daily(date=None):
    """
    å¾ TWSE ä¸‹è¼‰ ETF æ—¥æˆäº¤è³‡è¨Šï¼ˆHTML tableï¼‰
    date: '%Y%m%d' ä¾‹å¦‚ '20260112'
    """
    if date is None:
        date = datetime.now().strftime("%Y%m%d")

    url = "https://www.twse.com.tw/exchangeReport/ETFDaily"
    params = {"response": "json", "date": date}
    try:
        r = requests.get(url, params=params, timeout=10)
        r.raise_for_status()
        data = r.json().get("data", [])
        cols = r.json().get("fields", [])
        df = pd.DataFrame(data, columns=cols)
        df["æˆäº¤è‚¡æ•¸"] = pd.to_numeric(df["æˆäº¤è‚¡æ•¸"], errors="coerce")
        df["æˆäº¤é‡‘é¡"] = pd.to_numeric(df["æˆäº¤é‡‘é¡"], errors="coerce")
        return df
    except Exception as e:
        st.error(f"ç„¡æ³•æŠ“å– TWSE æˆäº¤è³‡æ–™: {e}")
        return pd.DataFrame()

# ===============================
# 2ï¸âƒ£ æŠ“å– ETF è©³ç´°è³‡è¨Šï¼ˆå«é…æ¯ & å ±é…¬ï¼‰
# ===============================
@st.cache_data(ttl=600)
def fetch_etf_details(code):
    try:
        ticker = yf.Ticker(code + ".TW")
        hist = ticker.history(period="1y")
        price_now = hist["Close"].iloc[-1] if not hist.empty else 0
        price_1y_ago = hist["Close"].iloc[0] if not hist.empty else 0
        dividends = hist.get("Dividends", pd.Series()).fillna(0)
        annual_div = dividends.sum()
        annual_yield = (annual_div / price_1y_ago * 100) if price_1y_ago else 0
        total_return = ((price_now + annual_div) / price_1y_ago - 1) * 100 if price_1y_ago else 0

        recent = dividends[dividends > 0]
        latest_div = recent.iloc[-1] if not recent.empty else 0
        latest_date = recent.index[-1].strftime("%Y-%m-%d") if not recent.empty else "N/A"

        return {
            "ä»£ç¢¼": code,
            "å³æ™‚åƒ¹": round(price_now, 2),
            "å¹´åŒ–é…æ¯ç‡ (%)": round(annual_yield, 2),
            "éå»ä¸€å¹´ç¸½å ±é…¬ç‡ (%)": round(total_return, 2),
            "æœ€æ–°é™¤æ¯é‡‘é¡": round(latest_div,2),
            "æœ€æ–°é™¤æ¯æ—¥": latest_date
        }
    except Exception as e:
        return {"ä»£ç¢¼": code, "å³æ™‚åƒ¹":0,"å¹´åŒ–é…æ¯ç‡ (%)":0,"éå»ä¸€å¹´ç¸½å ±é…¬ç‡ (%)":0,"æœ€æ–°é™¤æ¯é‡‘é¡":0,"æœ€æ–°é™¤æ¯æ—¥":"N/A"}

# ===============================
# 3ï¸âƒ£ è¨ˆç®—é¢¨éšªæŒ‡æ•¸
# ===============================
def compute_etf_risk_index(row):
    # ç°¡å–®é¢¨éšªå…¬å¼
    return round(
        0.4 * (100 - row["éå»ä¸€å¹´ç¸½å ±é…¬ç‡ (%)"]) * 0.01 +
        0.3 * (100 - row["å¹´åŒ–é…æ¯ç‡ (%)"]) * 0.01 +
        0.3 * (row["æˆäº¤é‡æ¨™æº–åŒ–"]),
        3
    )

# ===============================
# UI
# ===============================
if st.button("ğŸ“¡ æ›´æ–°ç†±é–€ ETF æ’å"):
    # 1) æŠ“æˆäº¤è³‡æ–™
    df_trade = fetch_twse_etf_daily()

    if df_trade.empty:
        st.warning("æ²’æœ‰å–å¾—æˆäº¤è³‡æ–™ï¼")
    else:
        # 2) å–å‡ºæˆäº¤æœ€é«˜çš„å‰ 10 æ”¯ ETF
        df_sorted = df_trade.sort_values("æˆäº¤è‚¡æ•¸", ascending=False).head(10)
        df_sorted["ä»£ç¢¼"] = df_sorted["è­‰åˆ¸ä»£è™Ÿ"].astype(str)

        # 3) åŠ ä¸Š ETF è©³ç´°è³‡è¨Š
        details = []
        max_vol = df_sorted["æˆäº¤è‚¡æ•¸"].max()
        for _, r in df_sorted.iterrows():
            code = r["ä»£ç¢¼"]
            det = fetch_etf_details(code)
            det["æˆäº¤é‡"] = r["æˆäº¤è‚¡æ•¸"]
            det["æˆäº¤å€¼"] = r["æˆäº¤é‡‘é¡"]
            # æˆäº¤é‡æ¨™æº–åŒ–ï¼ˆ0~1ï¼‰
            det["æˆäº¤é‡æ¨™æº–åŒ–"] = det["æˆäº¤é‡"] / max_vol if max_vol else 0
            details.append(det)
            time.sleep(1)  # é¿å…è¢« yfinance é™æµ

        df_result = pd.DataFrame(details)
        # 4) é¢¨éšªæŒ‡æ•¸
        df_result["é¢¨éšªæŒ‡æ•¸"] = df_result.apply(compute_etf_risk_index, axis=1)
        st.dataframe(df_result, use_container_width=True)

st.info("ç†±é–€æ’åä¾ TWSE æˆäº¤é‡ï¼ˆæˆäº¤è‚¡æ•¸æ’åºï¼‰æ±ºå®šï¼Œå†è¨ˆç®—é¢¨éšªæŒ‡æ•¸")
