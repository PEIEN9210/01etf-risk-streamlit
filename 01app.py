# -*- coding: utf-8 -*-
"""app.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1Y1jRJvzhlUjdd66vnUOBj57YzwXHYc1s
"""

# app_final.py
# -*- coding: utf-8 -*-
import streamlit as st
import pandas as pd
import numpy as np
import yfinance as yf
from datetime import datetime, timedelta
import plotly.express as px

st.set_page_config(page_title="ğŸ“Š ETF å€‹äººåŒ–æ¨è–¦ (Sharpe + Î¸-model)", layout="wide")
st.title("ğŸ“Š ETF å€‹äººåŒ–æ¨è–¦ (Sharpe + Î¸-model)")

# -------------------------------
# 1ï¸âƒ£ ETF åˆ—è¡¨èˆ‡å‹æ…‹
# -------------------------------
ETF_LIST = [
    "0050.TW","0056.TW","006208.TW","00713.TW","00878.TW",
    "00692.TW","00900.TW","00695B.TW","00794B.TW","00772B.TW","00757.TW"
]
ETF_TYPE_MAPPING = {
    "0050.TW": "è‚¡ç¥¨å‹","0056.TW":"é«˜è‚¡æ¯å‹","006208.TW":"è‚¡ç¥¨å‹",
    "00713.TW":"é«˜è‚¡æ¯å‹","00878.TW":"é«˜è‚¡æ¯å‹","00692.TW":"è‚¡ç¥¨å‹",
    "00900.TW":"é«˜è‚¡æ¯å‹","00695B.TW":"å‚µåˆ¸å‹","00794B.TW":"å‚µåˆ¸å‹",
    "00772B.TW":"å‚µåˆ¸å‹","00757.TW":"è‚¡ç¥¨å‹"
}

# -------------------------------
# 2ï¸âƒ£ ä½¿ç”¨è€…è¼¸å…¥
# -------------------------------
st.subheader("ğŸ‘¤ æŠ•è³‡äººè³‡æ–™")
cols = st.columns(6)
age = cols[0].slider("å¹´é½¡",20,80,35)
horizon = cols[1].slider("æŠ•è³‡å¹´é™",1,40,10)
loss_tol = cols[2].slider("æœ€å¤§å¯æ¥å—æå¤± (%)",0,50,15)
expected_return = cols[3].slider("é æœŸå ±é…¬ (%)",0,50,10)
expected_dividend = cols[4].slider("æœŸæœ›é…æ¯ (%)",0,50,3)
market_react = cols[5].radio("å¸‚å ´ä¸‹è·Œ 20%:", ["ç«‹å³è³£å‡º","æŒæœ‰è§€æœ›","é€¢ä½åŠ ç¢¼"])

# -------------------------------
# 3ï¸âƒ£ Î¸-model è¨ˆç®— (Grable & Lytton 1999)
# -------------------------------
def calculate_theta(age,horizon,loss_tol,market_react,expected_return,expected_dividend):
    """
    å°‡å„é …ä½¿ç”¨è€…è³‡æ–™è½‰æ›ç‚ºé¢¨éšªæ‰¿å—åº¦ theta [-3,3]
    """
    mr_weight = {"ç«‹å³è³£å‡º":-1,"æŒæœ‰è§€æœ›":0,"é€¢ä½åŠ ç¢¼":1.2}[market_react]
    theta = (
        -0.03*(age-40) +
        0.04*horizon +
        0.05*(loss_tol-15) +
        mr_weight +
        0.03*expected_return +
        0.02*expected_dividend
    )
    theta = max(min(theta,3),-3)  # å›ºå®šç¯„åœ
    return theta

theta = calculate_theta(age,horizon,loss_tol,market_react,expected_return,expected_dividend)
theta_scaled = (theta + 3)/6  # -3~3 -> 0~1, ç”¨æ–¼åŠ æ¬Š

# -------------------------------
# 4ï¸âƒ£ ETF è³‡æ–™æŠ“å–ï¼ˆYahoo Finance fallbackï¼‰
# -------------------------------
@st.cache_data(ttl=600)
def fetch_etf_data(etf_list):
    df_list = []
    for code in etf_list:
        try:
            ticker = yf.Ticker(code)
            hist = ticker.history(period="1y")
            if hist.empty:
                continue
            price = hist["Close"]
            returns = price.pct_change().dropna()
            sharpe = (returns.mean()/returns.std())*np.sqrt(252)  # Sharpe ratio
            beta = np.cov(returns, returns)[0,1]/returns.var()     # è‡ªå·±å°è‡ªå·±è¨ˆç®— Beta fallback
            avg_vol = hist["Volume"].tail(5).mean()
            df_list.append({
                "ä»£ç¢¼": code,
                "å‹æ…‹": ETF_TYPE_MAPPING.get(code,"æœªçŸ¥å‹æ…‹"),
                "å³æ™‚åƒ¹": price.iloc[-1],
                "å¹´åŒ–é…æ¯ç‡ (%)": ticker.info.get("dividendYield",0)*100 if ticker.info.get("dividendYield") else 0,
                "æœ€æ–°é™¤æ¯æ—¥": ticker.info.get("exDividendDate","N/A"),
                "éå»ä¸€å¹´ç¸½å ±é…¬ç‡ (%)": (price.iloc[-1]-price.iloc[0])/price.iloc[0]*100,
                "Sharpe": sharpe,
                "Beta": beta,
                "å¹³å‡æˆäº¤é‡": avg_vol,
                "æ­·å²åƒ¹æ ¼": hist
            })
        except Exception as e:
            st.warning(f"{code} æŠ“å–å¤±æ•—: {e}")
    return pd.DataFrame(df_list)

df_etf = fetch_etf_data(ETF_LIST)

if df_etf.empty:
    st.error("âš  ç„¡æ³•å–å¾— ETF è³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦")
else:
    # -------------------------------
    # 5ï¸âƒ£ å¸‚å ´ç†±é–€æ’åº (ä¾å¹³å‡æˆäº¤é‡)
    # -------------------------------
    df_hot = df_etf.sort_values("å¹³å‡æˆäº¤é‡",ascending=False).reset_index(drop=True)
    st.subheader("ğŸ”¥ å¸‚å ´ç†±é–€ ETFï¼ˆå¹³å‡æˆäº¤é‡æ’åºï¼‰")
    st.dataframe(df_hot[["ä»£ç¢¼","å‹æ…‹","å³æ™‚åƒ¹","å¹³å‡æˆäº¤é‡"]])

    # -------------------------------
    # 6ï¸âƒ£ å€‹äººåŒ–æ¨è–¦æ’åº
    # -------------------------------
    # å€‹äººåŒ–åˆ†æ•¸: Sharpe + Beta + Î¸-model
    df_hot["theta_scaled"] = theta_scaled
    df_hot["å€‹äººåŒ–åˆ†æ•¸"] = df_hot["Sharpe"]*0.5 - df_hot["Beta"]*0.2 + df_hot["theta_scaled"]*2.0
    df_hot["é¢¨éšªç­‰ç´š"] = df_hot["Sharpe"].apply(
        lambda x: "ğŸ”¥å¾ˆå¥½" if x>1.0 else ("ğŸŸ¡ä¸­ç­‰" if x>0.5 else "ğŸŸ¢ä¿å®ˆ")
    )
    df_personal = df_hot.sort_values("å€‹äººåŒ–åˆ†æ•¸",ascending=False).reset_index(drop=True)
    st.subheader("ğŸ¯ å€‹äººåŒ– ETF æ¨è–¦æ’åº (Sharpe + Î¸-model)")
    st.dataframe(df_personal[["ä»£ç¢¼","å‹æ…‹","å³æ™‚åƒ¹","Sharpe","Beta","theta_scaled","å€‹äººåŒ–åˆ†æ•¸","é¢¨éšªç­‰ç´š"]])

    # -------------------------------
    # 7ï¸âƒ£ é›·é”åœ–å¯è¦–åŒ–
    # -------------------------------
    st.subheader("ğŸ“Š å€‹äººåŒ–æ¨è–¦é›·é”åœ–")
    radar_df = df_personal.head(5)[["ä»£ç¢¼","Sharpe","Beta","theta_scaled"]].set_index("ä»£ç¢¼")
    radar_df = radar_df.rename(columns={"Sharpe":"Sharpe Ratio","Beta":"Beta","theta_scaled":"Î¸-model"})
    fig = px.line_polar(radar_df.reset_index(), r=radar_df.values.flatten(),
                        theta=list(radar_df.columns)*5,
                        color=np.repeat(radar_df.index,3),
                        line_close=True,
                        markers=True)
    st.plotly_chart(fig, use_container_width=True)

st.info("ğŸ“Œ è³‡æ–™ä¾†æºï¼šYahoo Financeï½œÎ¸-model åƒè€ƒ Grable & Lytton 1999ï½œSharpe Ratio åƒè€ƒ Sharpe 1966ï½œBeta åƒè€ƒ CAPM Lintner 1965ï½œåƒ…ä¾›åƒè€ƒï¼ŒæŠ•è³‡éœ€è‡ªè² é¢¨éšª")
