# -*- coding: utf-8 -*-
"""app.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1Y1jRJvzhlUjdd66vnUOBj57YzwXHYc1s
"""

# app.py
# -*- coding: utf-8 -*-
import streamlit as st
import pandas as pd
import numpy as np
import yfinance as yf
from datetime import datetime, timedelta

st.set_page_config(page_title="å°ç£ ETF Sharpe æ’åº + å€‹äººåŒ–é¢¨éšª", layout="wide")
st.title("ğŸ“Š å°ç£ç†±é–€ ETF + Sharpe Ratio é¢¨éšªæ’åº")

CACHE_TTL = 300
TOP_N = 5
TRADING_DAYS = 252
MARKET_BENCHMARK = "0050.TW"  # Beta è¨ˆç®—åŸºæº–

# -------------------------------
# 1ï¸âƒ£ ETF å‹æ…‹ mapping
# -------------------------------
ETF_TYPE_MAPPING = {
    "0050.TW": "è‚¡ç¥¨å‹",
    "0056.TW": "é«˜è‚¡æ¯å‹",
    "006208.TW": "è‚¡ç¥¨å‹",
    "00713.TW": "é«˜è‚¡æ¯å‹",
    "00878.TW": "é«˜è‚¡æ¯å‹",
    "00692.TW": "è‚¡ç¥¨å‹",
    "00900.TW": "é«˜è‚¡æ¯å‹",
    "00695B.TW": "å‚µåˆ¸å‹",
    "00794B.TW": "å‚µåˆ¸å‹",
    "00772B.TW": "å‚µåˆ¸å‹",
    "00757.TW": "è‚¡ç¥¨å‹",
}

# -------------------------------
# 2ï¸âƒ£ æŠ“ TWSE ETF æœ€è¿‘ 1â€“5 æ—¥å¹³å‡æˆäº¤é‡
# -------------------------------
@st.cache_data(ttl=CACHE_TTL)
def fetch_twse_avg_volume():
    try:
        url = "https://www.twse.com.tw/exchangeReport/MI_INDEX?response=html&date=&type=ALL"
        tables = pd.read_html(url)
        df = pd.concat(tables, ignore_index=True)
        df = df.rename(columns=lambda x: x.strip())
        # ç¯©é¸ ETF
        df = df[df["è­‰åˆ¸åç¨±"].str.contains("ETF")]
        df["æˆäº¤è‚¡æ•¸"] = df["æˆäº¤è‚¡æ•¸"].replace("-", 0).astype(float)
        # å–è¿‘ 5 æ—¥å¹³å‡ï¼ˆè‹¥è³‡æ–™ä¸å¤ å°±å–ç•¶æ—¥ï¼‰
        avg_volume = df.groupby("è­‰åˆ¸ä»£è™Ÿ")["æˆäº¤è‚¡æ•¸"].mean()
        return avg_volume
    except Exception:
        # fallback: å›ºå®šåˆ—è¡¨
        return pd.Series(
            [1]*len(ETF_TYPE_MAPPING),
            index=[k.replace(".TW","") for k in ETF_TYPE_MAPPING.keys()]
        )

# -------------------------------
# 3ï¸âƒ£ æŠ“ ETF è©³ç´°è³‡è¨Šï¼ˆYahoo Financeï¼‰
# -------------------------------
@st.cache_data(ttl=CACHE_TTL)
def fetch_etf_info(code):
    try:
        ticker = yf.Ticker(code)
        hist = ticker.history(period="1y", actions=True)
        if hist.empty:
            return None

        price_now = hist["Close"].iloc[-1]
        price_1y_ago = hist["Close"].iloc[0]

        # é…æ¯
        dividends = hist.get("Dividends", pd.Series()).fillna(0)
        total_div = dividends.sum()
        annual_div = total_div * (TRADING_DAYS / len(hist)) if len(hist)>0 else 0

        # å¹´åŒ–ç¸½å ±é…¬
        total_return = (price_now + total_div)/price_1y_ago -1

        return {
            "ä»£ç¢¼": code,
            "å‹æ…‹": ETF_TYPE_MAPPING.get(code, "æœªçŸ¥å‹æ…‹"),
            "å³æ™‚åƒ¹": round(price_now,2),
            "å¹´åŒ–é…æ¯ç‡ (%)": round(annual_div/price_1y_ago*100,2),
            "æœ€æ–°é™¤æ¯é‡‘é¡": round(dividends.iloc[-1] if not dividends.empty else 0,2),
            "æœ€æ–°é™¤æ¯æ—¥": dividends.index[-1].strftime("%Y-%m-%d") if not dividends.empty else "N/A",
            "éå»ä¸€å¹´ç¸½å ±é…¬ç‡ (%)": round(total_return*100,2),
            "hist": hist  # ç”¨æ–¼å¾ŒçºŒ Sharpe/Beta è¨ˆç®—
        }
    except Exception:
        return None

# -------------------------------
# 4ï¸âƒ£ è¨ˆç®— Sharpe Ratio èˆ‡ Beta
# -------------------------------
def compute_sharpe_beta(etf_hist, market_hist=None, risk_free_rate=0.01):
    returns = etf_hist["Close"].pct_change().dropna()
    annual_return = (1 + returns.mean())**TRADING_DAYS -1
    annual_vol = returns.std() * np.sqrt(TRADING_DAYS)
    sharpe = (annual_return - risk_free_rate)/annual_vol if annual_vol>0 else 0

    beta = None
    if market_hist is not None:
        market_returns = market_hist["Close"].pct_change().dropna()
        if len(market_returns) == len(returns):
            cov = np.cov(returns, market_returns)[0][1]
            beta = cov / market_returns.var() if market_returns.var() >0 else None
    return sharpe, beta

# -------------------------------
# ä½¿ç”¨è€…è¼¸å…¥
# -------------------------------
cols = st.columns(6)
age = cols[0].slider("ğŸ‘¤ å¹´é½¡",20,80,35)
horizon = cols[1].slider("â³ æŠ•è³‡å¹´é™",1,40,10)
loss_tol = cols[2].slider("ğŸ’¥ æœ€å¤§å¯æ¥å—æå¤± (%)",0,50,15)
expected_return = cols[3].slider("ğŸ¯ é æœŸå ±é…¬ (%)",0,50,10)
expected_dividend = cols[4].slider("ğŸ’° æœŸæœ›é…æ¯ (%)",0,50,3)
market_react = cols[5].radio("ğŸ“‰ å¸‚å ´ä¸‹è·Œ 20%", ["ç«‹å³è³£å‡º","æŒæœ‰è§€æœ›","é€¢ä½åŠ ç¢¼"])

# -------------------------------
# 5ï¸âƒ£ æŠ“ç†±é–€ ETF
# -------------------------------
if st.button("ğŸ“¡ æŠ“ç†±é–€ ETF æœ€æ–°è³‡è¨Š"):
    avg_vol = fetch_twse_avg_volume()
    etf_codes = list(ETF_TYPE_MAPPING.keys())
    df_list = []
    market_hist = fetch_etf_info(MARKET_BENCHMARK)["hist"]

    for code in etf_codes:
        info = fetch_etf_info(code)
        if info is None:
            continue
        sharpe, beta = compute_sharpe_beta(info["hist"], market_hist)
        info["Sharpe Ratio"] = round(sharpe,2)
        info["Beta"] = round(beta,2) if beta is not None else "N/A"
        # åŠ å…¥æˆäº¤é‡
        etf_id = code.replace(".TW","")
        info["å¹³å‡æˆäº¤é‡"] = avg_vol.get(etf_id, 0)
        df_list.append(info)

    df = pd.DataFrame(df_list)
    # å…ˆä¾å¹³å‡æˆäº¤é‡æ’åºï¼Œå†ä¾ Sharpe Ratio æ’åº
    df = df.sort_values(["å¹³å‡æˆäº¤é‡","Sharpe Ratio"], ascending=False)
    st.subheader("ğŸ“ˆ æœ€æ–°ç†±é–€ ETF è³‡è¨Šï¼ˆå¹³å‡æˆäº¤é‡ + Sharpe Ratio æ’åºï¼‰")
    st.dataframe(df, use_container_width=True)

# -------------------------------
# 6ï¸âƒ£ é¢¨éšªç´šåˆ¥é¡¯ç¤º
# -------------------------------
def sharpe_to_level(sharpe):
    if sharpe > 1.0:
        return "ğŸ”¥å¾ˆå¥½"
    elif sharpe >0.5:
        return "ğŸŸ¡ä¸­ç­‰"
    else:
        return "ğŸŸ¢ä¸ä½³"

if st.button("ğŸš€ è¨ˆç®—å€‹äººåŒ–æ¨è–¦"):
    df["é¢¨éšªç­‰ç´š"] = df["Sharpe Ratio"].apply(sharpe_to_level)
    st.subheader("ğŸ“Š ETF å€‹äººåŒ–æ¨è–¦")
    st.dataframe(df.head(TOP_N), use_container_width=True)

st.info("ğŸ“Œ è³‡æ–™ä¾†æºï¼šYahoo Finance + TWSEï½œåƒ…ä¾›åƒè€ƒï¼ŒæŠ•è³‡éœ€è‡ªè² é¢¨éšª")
